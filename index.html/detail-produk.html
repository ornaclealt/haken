<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk - Haken Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } }
                }
            }
        }
    </script>
</head>
<body class="bg-white font-sans text-stone-800 antialiased min-h-screen flex flex-col">

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-stone-200 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html#shop" class="group flex items-center gap-3 text-sm font-bold text-stone-600 hover:text-orange-600 transition-colors">
                <div class="p-2 bg-stone-100 rounded-full group-hover:bg-orange-100 transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </div>
                <span>Kembali</span>
            </a>
            <div class="font-serif font-bold text-lg text-stone-900 tracking-tight">Haken Studio.</div>
        </div>
    </nav>

    <section class="flex-1 flex flex-col justify-center py-10 md:py-16">
        <div class="container mx-auto px-6">
            
            <div id="loadingState" class="text-center py-20">
                <div class="animate-spin w-10 h-10 border-4 border-stone-200 border-t-orange-600 rounded-full mx-auto mb-4"></div>
                <p class="text-stone-400 animate-pulse">Mengambil data...</p>
            </div>

            <div id="errorState" class="hidden text-center py-20 max-w-md mx-auto">
                <div class="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="package-search" class="w-10 h-10 text-stone-300"></i>
                </div>
                <h1 class="text-2xl font-serif font-bold text-stone-900 mb-2">Produk Tidak Ditemukan</h1>
                <a href="index.html" class="inline-block px-8 py-3 bg-stone-900 text-white rounded-xl font-bold text-sm mt-4 hover:bg-orange-600 transition-colors">Kembali</a>
            </div>

            <div id="productContent" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-16 items-start max-w-6xl mx-auto">
                
                <div class="space-y-4">
                    <div class="aspect-[4/4] lg:aspect-[4/3] bg-stone-100 rounded-3xl overflow-hidden border border-stone-200 relative group shadow-sm">
                        <img id="mainImage" src="" alt="Product" class="w-full h-full object-cover transition-transform duration-700 hover:scale-105">
                        <div id="badgeContainer" class="absolute top-4 left-4 flex gap-2"></div>
                    </div>
                </div>

                <div class="lg:sticky lg:top-32">
                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-4">
                            <span id="category" class="px-3 py-1 bg-stone-100 text-stone-600 rounded-lg text-[10px] font-bold uppercase tracking-widest border border-stone-200">Category</span>
                            <span id="stockLabel" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-[10px] font-bold uppercase tracking-widest border border-green-200">Ready</span>
                        </div>
                        <h1 id="productName" class="text-3xl md:text-4xl lg:text-5xl font-serif font-bold text-stone-900 mb-4 leading-tight">Nama Produk</h1>
                        <div id="priceContainer" class="text-2xl md:text-3xl font-bold text-stone-900">IDR 0</div>
                    </div>

                    <div class="h-px w-full bg-stone-200 my-8"></div>

                    <div class="prose prose-stone text-stone-600 mb-10 leading-relaxed">
                        <h3 class="text-stone-900 font-bold text-xs uppercase tracking-wider mb-2">Deskripsi</h3>
                        <p id="description">...</p>
                    </div>

                    <div class="bg-white/50 backdrop-blur-sm p-4 rounded-2xl border border-stone-100 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] sticky bottom-4 lg:static lg:shadow-none lg:p-0 lg:border-0 lg:bg-transparent">
                        <button id="btnBuy" class="w-full py-4 bg-stone-900 text-white rounded-xl font-bold text-lg hover:bg-orange-600 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-xl shadow-stone-200">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            Tambah Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="checkoutModal" class="hidden fixed inset-0 z-[100] bg-stone-900/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 transition-all opacity-0">
        <div class="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-lg max-h-[90vh] overflow-y-auto shadow-2xl transition-transform translate-y-full md:translate-y-0 scale-95 duration-300 relative">
            
            <div id="submitOverlay" class="hidden absolute inset-0 bg-white/90 z-50 flex flex-col items-center justify-center text-center">
                <div class="animate-spin w-10 h-10 border-4 border-stone-200 border-t-orange-600 rounded-full mb-4"></div>
                <h3 class="font-bold text-lg">Memproses Pesanan...</h3>
                <p class="text-sm text-stone-500">Mohon jangan tutup halaman ini.</p>
            </div>

            <div class="sticky top-0 bg-white z-10 p-5 border-b border-stone-100 flex justify-between items-center">
                <h2 class="font-serif font-bold text-lg text-stone-900">Buat Pesanan Baru</h2>
                <button onclick="window.closeModal()" class="p-2 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-stone-600"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="flex gap-4 p-4 bg-stone-50 rounded-xl border border-stone-100">
                    <img id="modalImg" src="" class="w-16 h-16 rounded-lg object-cover bg-white shadow-sm">
                    <div>
                        <h3 id="modalName" class="font-bold text-stone-900 text-sm">Product Name</h3>
                        <p id="modalPrice" class="text-xs text-orange-600 font-bold mt-1">IDR 0</p>
                    </div>
                </div>

                <form id="orderForm" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold uppercase text-stone-500 mb-1.5">Nama Pemesan</label>
                        <input type="text" id="custName" class="w-full p-3 bg-white border border-stone-200 rounded-xl text-sm focus:border-orange-500 outline-none" placeholder="Nama Lengkap">
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold uppercase text-stone-500 mb-1.5">Nomor HP</label>
                            <input type="tel" id="custPhone" class="w-full p-3 bg-white border border-stone-200 rounded-xl text-sm focus:border-orange-500 outline-none" placeholder="08...">
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-stone-500 mb-1.5">Jumlah</label>
                            <input type="number" id="custQty" value="1" min="1" onchange="window.updateTotal()" class="w-full p-3 bg-white border border-stone-200 rounded-xl text-sm focus:border-orange-500 outline-none text-center font-bold">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold uppercase text-stone-500 mb-1.5">Alamat Pengiriman</label>
                        <textarea id="custAddress" rows="2" class="w-full p-3 bg-white border border-stone-200 rounded-xl text-sm focus:border-orange-500 outline-none" placeholder="Alamat lengkap..."></textarea>
                    </div>
                </form>
            </div>

            <div class="sticky bottom-0 bg-white p-5 border-t border-stone-100 shadow-[0_-5px_20px_rgba(0,0,0,0.05)]">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-xs text-stone-500 font-bold uppercase">Total Tagihan</span>
                    <span id="grandTotal" class="text-2xl font-bold text-stone-900">IDR 0</span>
                </div>
                <button onclick="window.submitOrderAuto()" class="w-full py-3.5 bg-stone-900 text-white rounded-xl font-bold hover:bg-stone-800 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg">
                    <i data-lucide="send" class="w-5 h-5"></i>
                    Kirim Pesanan
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI DATABASE URL SAJA (AMAN KARENA NO WRITE ACCESS SELAIN DISINI) ---
        const DB_URL = "https://entry-6a64d-default-rtdb.firebaseio.com";
        
        let currentProduct = null;
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (!productId) { showError(); return; }

            // 1. GET DATA PRODUK (REST API)
            fetch(`${DB_URL}/products/${productId}.json`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loadingState').classList.add('hidden');
                    if (data) {
                        currentProduct = { id: productId, ...data };
                        renderProduct(currentProduct);
                        document.getElementById('productContent').classList.remove('hidden');
                    } else {
                        showError();
                    }
                })
                .catch(() => showError());
        });

        function renderProduct(p) {
            document.title = `${p.name} | Order`;
            document.getElementById('productName').textContent = p.name;
            document.getElementById('category').textContent = p.category;
            document.getElementById('description').textContent = p.desc || "-";
            document.getElementById('mainImage').src = p.image;
            
            const priceContainer = document.getElementById('priceContainer');
            const btnBuy = document.getElementById('btnBuy');
            const badgeContainer = document.getElementById('badgeContainer');

            let finalPrice = p.price;
            let currentStock = parseInt(p.stock);
            let isPromo = false;

            badgeContainer.innerHTML = '';

            if (p.discountStock > 0 && p.discountPrice) {
                isPromo = true;
                finalPrice = p.discountPrice;
                currentStock = parseInt(p.discountStock);
                priceContainer.innerHTML = `<span class="text-stone-400 line-through text-lg mr-2">IDR ${parseInt(p.price).toLocaleString()}</span><span class="text-orange-600">IDR ${parseInt(finalPrice).toLocaleString()}</span>`;
                badgeContainer.innerHTML = `<span class="px-3 py-1 bg-orange-600 text-white text-[10px] font-bold uppercase rounded-lg">Promo</span>`;
            } else {
                priceContainer.textContent = `IDR ${parseInt(p.price).toLocaleString()}`;
            }

            currentProduct.finalPrice = finalPrice;
            currentProduct.currentStock = currentStock;
            currentProduct.isPromo = isPromo;

            if (currentStock <= 0) {
                document.getElementById('stockLabel').textContent = "Sold Out";
                btnBuy.innerHTML = "Stok Habis";
                btnBuy.disabled = true;
                btnBuy.className = "w-full py-4 bg-stone-200 text-stone-400 rounded-xl font-bold text-lg cursor-not-allowed";
            } else {
                document.getElementById('stockLabel').textContent = currentStock < 5 ? `Sisa ${currentStock}` : "Ready";
                btnBuy.disabled = false;
                btnBuy.onclick = window.openModal;
            }
            lucide.createIcons();
        }

        // --- WINDOW FUNCTIONS ---

        window.openModal = () => {
            document.getElementById('modalName').textContent = currentProduct.name;
            document.getElementById('modalPrice').textContent = `IDR ${parseInt(currentProduct.finalPrice).toLocaleString()}`;
            document.getElementById('modalImg').src = currentProduct.image;
            document.getElementById('custQty').value = 1;
            document.getElementById('custQty').max = currentProduct.currentStock;
            window.updateTotal();
            
            const modal = document.getElementById('checkoutModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('translate-y-full', 'scale-95');
            }, 10);
        };

        window.closeModal = () => {
            const modal = document.getElementById('checkoutModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('translate-y-full', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.updateTotal = () => {
            let qty = parseInt(document.getElementById('custQty').value);
            if(qty > currentProduct.currentStock) { qty = currentProduct.currentStock; document.getElementById('custQty').value = qty; alert("Stok maksimal tercapai"); }
            if(qty < 1) { qty = 1; document.getElementById('custQty').value = 1; }
            document.getElementById('grandTotal').textContent = `IDR ${(currentProduct.finalPrice * qty).toLocaleString('id-ID')}`;
        };

        // --- CORE FUNCTION: AUTO SUBMIT KE DB TANPA SDK ---
        window.submitOrderAuto = async () => {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const address = document.getElementById('custAddress').value.trim();
            const qty = parseInt(document.getElementById('custQty').value);

            if(!name || !phone || !address) { alert("Mohon lengkapi semua data."); return; }

            // Tampilkan Loading Overlay
            document.getElementById('submitOverlay').classList.remove('hidden');

            const orderData = {
                productId: currentProduct.id,
                productName: currentProduct.name,
                qty: qty,
                total: currentProduct.finalPrice * qty,
                customerName: name,
                customerPhone: phone,
                customerAddress: address,
                status: 'Pesanan Baru (Menunggu Konfirmasi)', // Status awal
                timestamp: Date.now(),
                lastStatusUpdate: Date.now()
            };

            try {
                // 1. KIRIM DATA ORDER (POST REQUEST)
                const resOrder = await fetch(`${DB_URL}/orders.json`, {
                    method: 'POST',
                    body: JSON.stringify(orderData),
                    headers: { 'Content-Type': 'application/json' }
                });

                if(!resOrder.ok) throw new Error("Gagal kirim order");

                // 2. UPDATE STOK (PATCH REQUEST)
                // Note: Ini beresiko jika rules tidak mengizinkan write public.
                // Jika error di sini, minimal order sudah masuk.
                const stockPath = currentProduct.isPromo ? 'discountStock' : 'stock';
                const newStock = currentProduct.currentStock - qty;
                
                await fetch(`${DB_URL}/products/${currentProduct.id}.json`, {
                    method: 'PATCH',
                    body: JSON.stringify({ [stockPath]: newStock }),
                    headers: { 'Content-Type': 'application/json' }
                });

                // Sukses!
                alert("Pesanan Berhasil Dibuat! Admin akan segera menghubungi Anda.");
                window.location.reload();

            } catch (error) {
                console.error(error);
                alert("Terjadi kesalahan koneksi. Silakan coba lagi.");
                document.getElementById('submitOverlay').classList.add('hidden');
            }
        };

        function showError() {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
        }
    </script>
</body>
</html>
