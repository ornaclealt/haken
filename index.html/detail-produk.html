<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detail Produk - Haken Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } }
                }
            }
        }
    </script>
</head>
<body class="bg-white font-sans text-stone-800 antialiased min-h-screen flex flex-col">

    <nav class="sticky top-0 z-50 bg-white/90 backdrop-blur-md border-b border-stone-200 shadow-sm">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <a href="index.html#shop" class="group flex items-center gap-3 text-sm font-bold text-stone-600 hover:text-orange-600 transition-colors">
                <div class="p-2 bg-stone-100 rounded-full group-hover:bg-orange-100 transition-colors">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i>
                </div>
                <span>Kembali</span>
            </a>
            <div class="font-serif font-bold text-lg text-stone-900 tracking-tight">Haken Studio.</div>
        </div>
    </nav>

    <section class="flex-1 flex flex-col justify-center py-10 md:py-16">
        <div class="container mx-auto px-6">
            
            <div id="loadingState" class="text-center py-20">
                <div class="animate-spin w-10 h-10 border-4 border-stone-200 border-t-orange-600 rounded-full mx-auto mb-4"></div>
                <p class="text-stone-400 animate-pulse">Mengambil data...</p>
            </div>

            <div id="errorState" class="hidden text-center py-20 max-w-md mx-auto">
                <div class="w-20 h-20 bg-stone-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i data-lucide="package-search" class="w-10 h-10 text-stone-300"></i>
                </div>
                <h1 class="text-2xl font-serif font-bold text-stone-900 mb-2">Produk Tidak Ditemukan</h1>
                <a href="index.html" class="inline-block px-8 py-3 bg-stone-900 text-white rounded-xl font-bold text-sm mt-4 hover:bg-orange-600 transition-colors">Kembali</a>
            </div>

            <div id="productContent" class="hidden grid grid-cols-1 lg:grid-cols-2 gap-10 lg:gap-16 items-start max-w-6xl mx-auto">
                
                <div class="space-y-4">
                    <div class="aspect-[4/4] lg:aspect-[4/3] bg-stone-100 rounded-3xl overflow-hidden border border-stone-200 relative group shadow-sm">
                        <img id="mainImage" src="" alt="Product" class="w-full h-full object-cover transition-transform duration-700 hover:scale-105">
                        <div id="badgeContainer" class="absolute top-4 left-4 flex gap-2"></div>
                    </div>
                </div>

                <div class="lg:sticky lg:top-32">
                    <div class="mb-8">
                        <div class="flex items-center gap-2 mb-4">
                            <span id="category" class="px-3 py-1 bg-stone-100 text-stone-600 rounded-lg text-[10px] font-bold uppercase tracking-widest border border-stone-200">Category</span>
                            <span id="stockLabel" class="px-3 py-1 bg-green-100 text-green-700 rounded-lg text-[10px] font-bold uppercase tracking-widest border border-green-200">Ready</span>
                        </div>
                        <h1 id="productName" class="text-3xl md:text-4xl lg:text-5xl font-serif font-bold text-stone-900 mb-4 leading-tight">Nama Produk</h1>
                        <div id="priceContainer" class="text-2xl md:text-3xl font-bold text-stone-900">IDR 0</div>
                    </div>

                    <div class="h-px w-full bg-stone-200 my-8"></div>

                    <div class="prose prose-stone text-stone-600 mb-10 leading-relaxed">
                        <h3 class="text-stone-900 font-bold text-xs uppercase tracking-wider mb-2">Deskripsi</h3>
                        <p id="description">...</p>
                    </div>

                    <div class="bg-white/50 backdrop-blur-sm p-4 rounded-2xl border border-stone-100 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)] sticky bottom-4 lg:static lg:shadow-none lg:p-0 lg:border-0 lg:bg-transparent">
                        <button id="btnBuy" class="w-full py-4 bg-stone-900 text-white rounded-xl font-bold text-lg hover:bg-orange-600 active:scale-95 transition-all flex items-center justify-center gap-3 shadow-xl shadow-stone-200">
                            <i data-lucide="plus-circle" class="w-5 h-5"></i>
                            Tambah Order
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div id="checkoutModal" class="hidden fixed inset-0 z-[100] bg-stone-900/60 backdrop-blur-sm flex items-end md:items-center justify-center p-0 md:p-4 transition-all opacity-0">
        <div class="bg-white rounded-t-3xl md:rounded-3xl w-full max-w-sm max-h-[90vh] overflow-y-auto shadow-2xl transition-transform translate-y-full md:translate-y-0 scale-95 duration-300 relative">
            
            <div class="sticky top-0 bg-white z-10 p-5 border-b border-stone-100 flex justify-between items-center">
                <h2 class="font-serif font-bold text-lg text-stone-900">Atur Pesanan</h2>
                <button onclick="window.closeModal()" class="p-2 bg-stone-100 rounded-full hover:bg-stone-200 transition-colors">
                    <i data-lucide="x" class="w-5 h-5 text-stone-600"></i>
                </button>
            </div>
            
            <div class="p-6 space-y-6">
                <div class="flex gap-4 items-center">
                    <img id="modalImg" src="" class="w-20 h-20 rounded-xl object-cover bg-stone-50 border border-stone-100">
                    <div>
                        <h3 id="modalName" class="font-bold text-stone-900 leading-tight mb-1">Product Name</h3>
                        <p id="modalPrice" class="text-sm text-orange-600 font-bold">IDR 0</p>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold uppercase text-stone-500 mb-2">Mau pesan berapa?</label>
                    <div class="flex items-center border border-stone-200 rounded-xl overflow-hidden">
                        <button onclick="changeQty(-1)" class="px-4 py-3 bg-stone-50 hover:bg-stone-100 active:bg-stone-200 transition-colors border-r border-stone-200 text-stone-600">
                            <i data-lucide="minus" class="w-4 h-4"></i>
                        </button>
                        <input type="number" id="custQty" value="1" min="1" onchange="window.updateTotal()" class="flex-1 w-full text-center font-bold text-stone-900 outline-none p-2">
                        <button onclick="changeQty(1)" class="px-4 py-3 bg-stone-50 hover:bg-stone-100 active:bg-stone-200 transition-colors border-l border-stone-200 text-stone-600">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                        </button>
                    </div>
                </div>
            </div>

            <div class="sticky bottom-0 bg-white p-5 border-t border-stone-100">
                <div class="flex justify-between items-end mb-4">
                    <span class="text-xs text-stone-500 font-bold uppercase">Subtotal</span>
                    <span id="grandTotal" class="text-2xl font-bold text-stone-900">IDR 0</span>
                </div>
                <button onclick="window.addToCart()" class="w-full py-3.5 bg-stone-900 text-white rounded-xl font-bold hover:bg-orange-600 active:scale-95 transition-all flex items-center justify-center gap-2 shadow-lg">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    Masuk Keranjang
                </button>
            </div>
        </div>
    </div>
    <script>
        // --- KONFIGURASI DATABASE URL SAJA (AMAN KARENA NO WRITE ACCESS SELAIN DISINI) ---
        const DB_URL = "https://entry-6a64d-default-rtdb.firebaseio.com";
        
        let currentProduct = null;
        const urlParams = new URLSearchParams(window.location.search);
        const productId = urlParams.get('id');

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            if (!productId) { showError(); return; }

            // 1. GET DATA PRODUK (REST API)
            fetch(`${DB_URL}/products/${productId}.json`)
                .then(res => res.json())
                .then(data => {
                    document.getElementById('loadingState').classList.add('hidden');
                    if (data) {
                        currentProduct = { id: productId, ...data };
                        renderProduct(currentProduct);
                        document.getElementById('productContent').classList.remove('hidden');
                    } else {
                        showError();
                    }
                })
                .catch(() => showError());
        });

        function renderProduct(p) {
            document.title = `${p.name} | Order`;
            document.getElementById('productName').textContent = p.name;
            document.getElementById('category').textContent = p.category;
            document.getElementById('description').textContent = p.desc || "-";
            document.getElementById('mainImage').src = p.image;
            
            const priceContainer = document.getElementById('priceContainer');
            const btnBuy = document.getElementById('btnBuy');
            const badgeContainer = document.getElementById('badgeContainer');

            let finalPrice = p.price;
            let currentStock = parseInt(p.stock);
            let isPromo = false;

            badgeContainer.innerHTML = '';

            if (p.discountStock > 0 && p.discountPrice) {
                isPromo = true;
                finalPrice = p.discountPrice;
                currentStock = parseInt(p.discountStock);
                priceContainer.innerHTML = `<span class="text-stone-400 line-through text-lg mr-2">IDR ${parseInt(p.price).toLocaleString()}</span><span class="text-orange-600">IDR ${parseInt(finalPrice).toLocaleString()}</span>`;
                badgeContainer.innerHTML = `<span class="px-3 py-1 bg-orange-600 text-white text-[10px] font-bold uppercase rounded-lg">Promo</span>`;
            } else {
                priceContainer.textContent = `IDR ${parseInt(p.price).toLocaleString()}`;
            }

            currentProduct.finalPrice = finalPrice;
            currentProduct.currentStock = currentStock;
            currentProduct.isPromo = isPromo;

            if (currentStock <= 0) {
                document.getElementById('stockLabel').textContent = "Sold Out";
                btnBuy.innerHTML = "Stok Habis";
                btnBuy.disabled = true;
                btnBuy.className = "w-full py-4 bg-stone-200 text-stone-400 rounded-xl font-bold text-lg cursor-not-allowed";
            } else {
                document.getElementById('stockLabel').textContent = currentStock < 5 ? `Sisa ${currentStock}` : "Ready";
                btnBuy.disabled = false;
                btnBuy.onclick = window.openModal;
            }
            lucide.createIcons();
        }

        // --- WINDOW FUNCTIONS ---

        window.openModal = () => {
            document.getElementById('modalName').textContent = currentProduct.name;
            document.getElementById('modalPrice').textContent = `IDR ${parseInt(currentProduct.finalPrice).toLocaleString()}`;
            document.getElementById('modalImg').src = currentProduct.image;
            document.getElementById('custQty').value = 1;
            document.getElementById('custQty').max = currentProduct.currentStock;
            window.updateTotal();
            
            const modal = document.getElementById('checkoutModal');
            modal.classList.remove('hidden');
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.querySelector('div').classList.remove('translate-y-full', 'scale-95');
            }, 10);
        };

        window.closeModal = () => {
            const modal = document.getElementById('checkoutModal');
            modal.classList.add('opacity-0');
            modal.querySelector('div').classList.add('translate-y-full', 'scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        };

        window.updateTotal = () => {
            let qty = parseInt(document.getElementById('custQty').value);
            if(qty > currentProduct.currentStock) { qty = currentProduct.currentStock; document.getElementById('custQty').value = qty; alert("Stok maksimal tercapai"); }
            if(qty < 1) { qty = 1; document.getElementById('custQty').value = 1; }
            document.getElementById('grandTotal').textContent = `IDR ${(currentProduct.finalPrice * qty).toLocaleString('id-ID')}`;
        };

        // Fungsi helper untuk tombol plus minus qty
        window.changeQty = (delta) => {
            const input = document.getElementById('custQty');
            let val = parseInt(input.value) || 1;
            val += delta;
            if (val < 1) val = 1;
            if (val > currentProduct.currentStock) {
                val = currentProduct.currentStock;
                alert("Stok maksimal tercapai!");
            }
            input.value = val;
            window.updateTotal();
        }

        // FUNGSI BARU: SIMPAN KE LOCALSTORAGE (KERANJANG)
        window.addToCart = () => {
            const qty = parseInt(document.getElementById('custQty').value);
            
            // 1. Validasi Stok
            if(qty > currentProduct.currentStock) {
                alert("Stok tidak mencukupi!");
                return;
            }

            // 2. Buat Data Item
            const cartItem = {
                productId: currentProduct.id,
                name: currentProduct.name,
                image: currentProduct.image,
                price: currentProduct.finalPrice, // Harga yang sudah diproses (promo/normal)
                weight: 100, // Default berat (opsional)
                qty: qty,
                stockRef: currentProduct.currentStock
            };

            // 3. Ambil Keranjang Lama dari Browser
            let cart = JSON.parse(localStorage.getItem('haken_cart') || '[]');

            // 4. Cek Duplicate (Kalau produk udah ada, tambah qty-nya aja)
            const existingIndex = cart.findIndex(item => item.productId === cartItem.productId);
            if (existingIndex > -1) {
                // Cek limit stok lagi sebelum nambah
                if (cart[existingIndex].qty + qty > currentProduct.currentStock) {
                    alert("Total qty di keranjang melebihi stok yang tersedia!");
                    return;
                }
                cart[existingIndex].qty += qty;
            } else {
                cart.push(cartItem);
            }

            // 5. Simpan Balik
            localStorage.setItem('haken_cart', JSON.stringify(cart));

            // 6. Tutup Modal & Kasih Respon
            window.closeModal();
            
            // Animasi Feedback (Opsional)
            alert("Produk berhasil masuk keranjang!");
            
            // Redirect opsional (Mau langsung belanja lagi atau ke checkout?)
            // window.location.href = 'index.html'; 
        }
    </script>
</body>
</html>
