<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haken Master Database</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        serif: ['Merriweather', 'serif'],
                    },
                    colors: {
                        stone: { 850: '#1c1917', 950: '#0c0a09' }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap'); 
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 3px; }
        .dark ::-webkit-scrollbar-thumb { background: #44403c; }
        
        /* UI Components */
        .glass-nav { @apply backdrop-blur-2xl bg-white/70 dark:bg-stone-950/70 border-stone-200/50 dark:border-stone-800/50; }
        .input-field { 
            @apply w-full p-3 rounded-xl text-sm border outline-none transition-colors;
            @apply bg-white border-stone-200 text-stone-900 focus:border-orange-500;
            @apply dark:bg-stone-800 dark:border-stone-700 dark:text-white dark:focus:border-orange-500;
        }
        .btn-primary { @apply py-2.5 px-5 bg-stone-900 dark:bg-orange-600 text-white rounded-xl font-bold shadow-lg shadow-stone-200 dark:shadow-orange-900/20 hover:scale-[1.02] active:scale-95 transition-all; }
        .btn-secondary { @apply py-2.5 px-5 bg-white dark:bg-stone-800 border border-stone-200 dark:border-stone-700 text-stone-600 dark:text-stone-300 rounded-xl font-bold hover:bg-stone-50 dark:hover:bg-stone-700 transition-all; }
        
        .tab-btn { @apply px-6 py-3 text-sm font-bold border-b-2 border-transparent text-stone-400 transition-colors; }
        .tab-btn.active { @apply border-orange-500 text-stone-900 dark:text-white; }

        .animate-fade-in { animation: fadeIn 0.5s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-[#FDFCFC] dark:bg-stone-950 text-stone-800 dark:text-stone-200 h-screen overflow-hidden transition-colors duration-500">

    <div id="loginGate" class="fixed inset-0 z-[100] bg-stone-50/50 dark:bg-stone-950/80 backdrop-blur-xl flex items-center justify-center p-4 transition-all duration-500">
        <div class="bg-white dark:bg-stone-900 p-10 rounded-[2.5rem] w-full max-w-sm text-center shadow-2xl border border-white/20 dark:border-stone-800">
            <div class="w-16 h-16 bg-stone-100 dark:bg-stone-800 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="database" class="w-8 h-8 text-stone-900 dark:text-orange-500"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-stone-900 dark:text-white">Master Database</h2>
            <p class="text-stone-500 dark:text-stone-400 text-sm mb-8">Memverifikasi hak akses root...</p>
            <div class="w-8 h-8 border-4 border-orange-500 border-t-transparent rounded-full animate-spin mx-auto"></div>
        </div>
    </div>

    <div id="mainLayout" class="flex h-full hidden flex-col md:flex-row transition-opacity duration-500 opacity-0">
        
        <aside class="hidden md:flex w-20 lg:w-64 bg-white dark:bg-stone-900 border-r border-stone-100 dark:border-stone-800 flex-col z-20 transition-all">
            <div class="p-6 flex justify-center lg:justify-start">
                <div class="w-10 h-10 bg-stone-900 dark:bg-white rounded-xl flex items-center justify-center text-white dark:text-stone-900 font-bold text-xl">D</div>
                <span class="hidden lg:block ml-3 text-lg font-bold mt-1">Database.</span>
            </div>
            
            <nav class="flex-1 px-4 space-y-2 mt-4">
                <a href="admin.html" class="flex items-center gap-3 px-4 py-3 text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-xl text-sm font-medium transition-all group">
                    <i data-lucide="arrow-left" class="w-5 h-5 group-hover:-translate-x-1 transition-transform"></i>
                    <span class="hidden lg:block">Kembali ke Admin</span>
                </a>
                <div class="h-px bg-stone-100 dark:bg-stone-800 my-2 mx-2"></div>
                <button onclick="window.switchView('users')" id="nav-users" class="w-full flex items-center gap-3 px-4 py-3 bg-orange-50 dark:bg-orange-900/20 text-orange-600 dark:text-orange-400 rounded-xl text-sm font-bold transition-all">
                    <i data-lucide="users" class="w-5 h-5"></i>
                    <span class="hidden lg:block">Data Pengguna</span>
                </button>
                <button onclick="window.switchView('orders')" id="nav-orders" class="w-full flex items-center gap-3 px-4 py-3 text-stone-500 dark:text-stone-400 hover:bg-stone-100 dark:hover:bg-stone-800 rounded-xl text-sm font-medium transition-all">
                    <i data-lucide="shopping-cart" class="w-5 h-5"></i>
                    <span class="hidden lg:block">Arsip Pesanan</span>
                </button>
            </nav>

            <div class="p-6 border-t border-stone-100 dark:border-stone-800">
                <button onclick="window.toggleDarkMode()" class="p-3 w-full flex justify-center items-center bg-stone-50 dark:bg-stone-800 rounded-xl">
                    <i data-lucide="moon" class="w-5 h-5 dark:hidden"></i>
                    <i data-lucide="sun" class="w-5 h-5 hidden dark:block text-orange-400"></i>
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <header class="h-20 border-b border-stone-100 dark:border-stone-800 flex items-center justify-between px-6 md:px-10 glass-nav z-30">
                <div>
                    <h1 class="text-xl font-bold text-stone-900 dark:text-white" id="pageTitle">Data Pengguna</h1>
                    <p class="text-xs text-stone-400" id="pageSubtitle">Total: 0 Record</p>
                </div>
                <div class="flex gap-3">
                    <div class="relative hidden md:block w-64">
                        <input type="text" id="searchBox" placeholder="Cari data..." class="input-field pl-10">
                        <i data-lucide="search" class="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-stone-400"></i>
                    </div>
                    <button onclick="window.exportCSV()" class="btn-primary flex items-center gap-2">
                        <i data-lucide="download" class="w-4 h-4"></i> <span class="hidden md:inline">Export CSV</span>
                    </button>
                </div>
            </header>

            <div class="flex-1 overflow-auto p-6 md:p-10 scroll-smooth">
                
                <div id="view-users" class="animate-fade-in">
                    <div class="bg-white dark:bg-stone-900 rounded-[2rem] border border-stone-100 dark:border-stone-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-stone-50 dark:bg-stone-800 text-stone-500 dark:text-stone-400 font-bold uppercase text-xs">
                                    <tr>
                                        <th class="p-6">User Profile</th>
                                        <th class="p-6">Kontak</th>
                                        <th class="p-6">Last Login/Join</th>
                                        <th class="p-6 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableUsers" class="divide-y divide-stone-50 dark:divide-stone-800 text-stone-600 dark:text-stone-300">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="view-orders" class="hidden animate-fade-in">
                    <div class="bg-white dark:bg-stone-900 rounded-[2rem] border border-stone-100 dark:border-stone-800 shadow-sm overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-stone-50 dark:bg-stone-800 text-stone-500 dark:text-stone-400 font-bold uppercase text-xs">
                                    <tr>
                                        <th class="p-6">ID & Tanggal</th>
                                        <th class="p-6">Customer</th>
                                        <th class="p-6">Produk</th>
                                        <th class="p-6">Total & Status</th>
                                        <th class="p-6 text-right">Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="tableOrders" class="divide-y divide-stone-50 dark:divide-stone-800 text-stone-600 dark:text-stone-300">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>

            </div>

            <div class="md:hidden border-t border-stone-200 dark:border-stone-800 p-4 glass-nav flex justify-around">
                <button onclick="window.location.href='admin.html'" class="p-2 text-stone-400"><i data-lucide="arrow-left" class="w-6 h-6"></i></button>
                <button onclick="window.switchView('users')" class="p-2 text-orange-600 dark:text-orange-400"><i data-lucide="users" class="w-6 h-6"></i></button>
                <button onclick="window.switchView('orders')" class="p-2 text-stone-400"><i data-lucide="shopping-cart" class="w-6 h-6"></i></button>
            </div>
        </main>
    </div>

    <div id="detailModal" class="hidden fixed inset-0 z-[60] bg-stone-900/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-stone-900 w-full max-w-lg rounded-3xl p-8 shadow-2xl animate-fade-in border dark:border-stone-800 relative">
            <button onclick="document.getElementById('detailModal').classList.add('hidden')" class="absolute top-6 right-6 p-2 bg-stone-50 dark:bg-stone-800 rounded-full hover:rotate-90 transition-transform"><i data-lucide="x" class="w-5 h-5 dark:text-white"></i></button>
            
            <h3 class="text-xl font-bold mb-6 text-stone-900 dark:text-white">Raw Data Inspector</h3>
            <div class="bg-stone-50 dark:bg-stone-950 p-4 rounded-xl border border-stone-200 dark:border-stone-800 overflow-auto max-h-[60vh]">
                <pre id="jsonViewer" class="text-xs font-mono text-stone-600 dark:text-stone-400 whitespace-pre-wrap"></pre>
            </div>
            <div class="mt-6 flex gap-3">
                <button id="btnCopyJson" class="btn-secondary w-full">Copy JSON</button>
                <button id="btnDeleteRecord" class="bg-red-50 dark:bg-red-900/20 text-red-500 dark:text-red-400 font-bold py-2.5 px-5 rounded-xl w-full hover:bg-red-100 transition-colors">Hapus Data</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, get } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApD7dueaFuPv9hHGajcwo17LADEVriqRw",
            authDomain: "entry-6a64d.firebaseapp.com",
            databaseURL: "https://entry-6a64d-default-rtdb.firebaseio.com",
            projectId: "entry-6a64d",
            storageBucket: "entry-6a64d.firebasestorage.app",
            messagingSenderId: "939693440034",
            appId: "1:939693440034:web:ecd3d0366acf207add1e7b",
            measurementId: "G-RPTFXQK08B"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        let currentView = 'users';
        let rawDataUsers = {};
        let rawDataOrders = {};

        // --- DARK MODE ---
        if (localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');
        window.toggleDarkMode = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        };

        // --- AUTH & INIT ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Security Check
                const snapshot = await get(ref(db, 'admins/' + user.uid));
                if (snapshot.exists() && snapshot.val() === true) {
                    document.getElementById('loginGate').style.display = 'none';
                    document.getElementById('mainLayout').classList.remove('hidden');
                    setTimeout(() => document.getElementById('mainLayout').classList.remove('opacity-0'), 100);
                    initData();
                } else {
                    alert("Akses Ditolak.");
                    window.location.href = 'index.html';
                }
            } else {
                window.location.href = 'index.html';
            }
        });

        function initData() {
            // Load Users
            onValue(ref(db, 'users'), (snap) => {
                rawDataUsers = snap.val() || {};
                if(currentView === 'users') renderUsers();
            });

            // Load Orders
            onValue(ref(db, 'orders'), (snap) => {
                rawDataOrders = snap.val() || {};
                if(currentView === 'orders') renderOrders();
            });
        }

        // --- RENDERING ---
        window.switchView = (view) => {
            currentView = view;
            
            // UI Toggle
            document.getElementById('view-users').classList.add('hidden');
            document.getElementById('view-orders').classList.add('hidden');
            document.getElementById(`view-${view}`).classList.remove('hidden');

            // Nav Style
            const btnUsers = document.getElementById('nav-users');
            const btnOrders = document.getElementById('nav-orders');
            const activeClass = ['bg-orange-50', 'dark:bg-orange-900/20', 'text-orange-600', 'dark:text-orange-400', 'font-bold'];
            const inactiveClass = ['text-stone-500', 'dark:text-stone-400', 'hover:bg-stone-100', 'font-medium'];

            if(view === 'users') {
                btnUsers.classList.add(...activeClass); btnUsers.classList.remove(...inactiveClass);
                btnOrders.classList.remove(...activeClass); btnOrders.classList.add(...inactiveClass);
                document.getElementById('pageTitle').textContent = 'Data Pengguna';
                renderUsers();
            } else {
                btnOrders.classList.add(...activeClass); btnOrders.classList.remove(...inactiveClass);
                btnUsers.classList.remove(...activeClass); btnUsers.classList.add(...inactiveClass);
                document.getElementById('pageTitle').textContent = 'Arsip Pesanan';
                renderOrders();
            }
        };

        function renderUsers(filter = '') {
            const tbody = document.getElementById('tableUsers');
            tbody.innerHTML = '';
            const users = Object.entries(rawDataUsers).filter(([uid, u]) => 
                (u.displayName || '').toLowerCase().includes(filter) || (u.email || '').toLowerCase().includes(filter)
            );

            document.getElementById('pageSubtitle').textContent = `Total: ${users.length} User Terdaftar`;

            users.forEach(([uid, u]) => {
                tbody.innerHTML += `
                    <tr class="hover:bg-stone-50 dark:hover:bg-stone-800/50 transition-colors">
                        <td class="p-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-tr from-stone-200 to-stone-100 dark:from-stone-700 dark:to-stone-800 flex items-center justify-center font-bold text-stone-600 dark:text-stone-300">
                                    ${(u.displayName || 'U').charAt(0).toUpperCase()}
                                </div>
                                <div>
                                    <div class="font-bold text-stone-900 dark:text-white">${u.displayName || 'Tanpa Nama'}</div>
                                    <div class="text-[10px] text-stone-400 font-mono">UID: ${uid.slice(0,8)}...</div>
                                </div>
                            </div>
                        </td>
                        <td class="p-6">
                            <div class="text-sm text-stone-600 dark:text-stone-300">${u.email}</div>
                            <div class="text-xs text-stone-400">${u.phoneNumber || '-'}</div>
                        </td>
                        <td class="p-6">
                            <span class="px-3 py-1 bg-blue-50 dark:bg-blue-900/20 text-blue-600 dark:text-blue-400 text-xs rounded-full font-bold">Registered</span>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="window.inspectData('users', '${uid}')" class="text-stone-400 hover:text-stone-900 dark:hover:text-white"><i data-lucide="eye" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        function renderOrders(filter = '') {
            const tbody = document.getElementById('tableOrders');
            tbody.innerHTML = '';
            const orders = Object.entries(rawDataOrders)
                .sort((a,b) => b.val.timestamp - a.val.timestamp)
                .filter(([id, o]) => 
                    (o.customerName || '').toLowerCase().includes(filter) || id.includes(filter)
                );

            document.getElementById('pageSubtitle').textContent = `Total: ${orders.length} Transaksi`;

            orders.forEach(([id, o]) => {
                const date = new Date(o.timestamp).toLocaleDateString();
                let statusColor = 'text-stone-500 bg-stone-100 dark:bg-stone-800';
                if(o.status.includes('Selesai')) statusColor = 'text-green-600 bg-green-50 dark:bg-green-900/20';
                if(o.status.includes('Batal')) statusColor = 'text-red-600 bg-red-50 dark:bg-red-900/20';

                tbody.innerHTML += `
                    <tr class="hover:bg-stone-50 dark:hover:bg-stone-800/50 transition-colors">
                        <td class="p-6">
                            <div class="font-bold text-stone-900 dark:text-white">#${id.slice(-6)}</div>
                            <div class="text-xs text-stone-400">${date}</div>
                        </td>
                        <td class="p-6">
                            <div class="font-bold text-stone-800 dark:text-stone-200">${o.customerName}</div>
                            <div class="text-xs text-stone-400">${o.customerPhone}</div>
                        </td>
                        <td class="p-6">
                            <div class="text-sm text-stone-600 dark:text-stone-300">${o.productName}</div>
                            <div class="text-xs text-stone-400">Qty: ${o.qty}</div>
                        </td>
                        <td class="p-6">
                            <div class="font-bold text-stone-900 dark:text-white">Rp ${parseInt(o.total).toLocaleString()}</div>
                            <span class="inline-block mt-1 px-2 py-0.5 rounded text-[10px] font-bold uppercase ${statusColor}">${o.status}</span>
                        </td>
                        <td class="p-6 text-right">
                            <button onclick="window.inspectData('orders', '${id}')" class="text-stone-400 hover:text-stone-900 dark:hover:text-white"><i data-lucide="eye" class="w-5 h-5"></i></button>
                        </td>
                    </tr>
                `;
            });
            lucide.createIcons();
        }

        // --- SEARCH & EXPORT ---
        document.getElementById('searchBox').addEventListener('keyup', (e) => {
            const val = e.target.value.toLowerCase();
            if(currentView === 'users') renderUsers(val);
            else renderOrders(val);
        });

        window.exportCSV = () => {
            let data, filename;
            if(currentView === 'users') {
                data = Object.values(rawDataUsers);
                filename = 'Haken_Users.csv';
            } else {
                data = Object.values(rawDataOrders);
                filename = 'Haken_Orders.csv';
            }

            if(data.length === 0) return alert("Tidak ada data untuk diexport.");

            const keys = Object.keys(data[0]);
            const csvContent = [
                keys.join(','),
                ...data.map(row => keys.map(k => JSON.stringify(row[k] || '')).join(','))
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        };

        // --- DETAIL INSPECTOR ---
        window.inspectData = (type, id) => {
            const data = type === 'users' ? rawDataUsers[id] : rawDataOrders[id];
            const modal = document.getElementById('detailModal');
            document.getElementById('jsonViewer').textContent = JSON.stringify(data, null, 2);
            modal.classList.remove('hidden');
            
            // Delete Logic
            document.getElementById('btnDeleteRecord').onclick = () => {
                if(confirm('Yakin hapus data ini permanen? Data yang hilang tidak bisa kembali.')) {
                    remove(ref(db, `${type}/${id}`)).then(() => modal.classList.add('hidden'));
                }
            };
        };

        // Init default
        lucide.createIcons();
    </script>
</body>
</html>
