<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Haken Command Center</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        brand: { 500: '#f97316', 600: '#ea580c', 900: '#7c2d12' },
                        dark: { 800: '#1c1917', 900: '#0c0a09' }
                    }
                }
            }
        }
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #d6d3d1; border-radius: 10px; }
        .dark ::-webkit-scrollbar-thumb { background: #44403c; }

        /* Glass Components */
        .glass-panel { @apply bg-white/80 dark:bg-dark-900/80 backdrop-blur-xl border border-gray-100 dark:border-gray-800; }
        
        /* Inputs */
        .input-modern { 
            @apply w-full px-4 py-3 rounded-xl text-sm font-medium outline-none transition-all;
            @apply bg-gray-50 border border-gray-200 text-gray-900 focus:border-brand-600 focus:ring-2 focus:ring-brand-100;
            @apply dark:bg-dark-800 dark:border-gray-700 dark:text-white dark:focus:border-brand-600 dark:focus:ring-brand-900;
        }

        /* Sidebar Link Active State */
        .nav-item.active { @apply bg-brand-50 text-brand-600 dark:bg-brand-900/20 dark:text-brand-500 border-r-4 border-brand-600; }
    </style>
</head>
<body class="bg-gray-50 dark:bg-black text-gray-800 dark:text-gray-200 h-screen flex overflow-hidden transition-colors duration-300">

    <div id="loginGate" class="fixed inset-0 z-[100] bg-gray-50 dark:bg-black flex items-center justify-center p-6">
        <div class="max-w-sm w-full text-center space-y-8 animate-fade-in">
            <div class="inline-flex p-4 rounded-3xl bg-brand-600 shadow-2xl shadow-brand-500/30">
                <i data-lucide="command" class="w-10 h-10 text-white"></i>
            </div>
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white">Haken Command.</h1>
                <p class="text-gray-500 mt-2 text-sm">Verifikasi identitas Admin diperlukan.</p>
            </div>
            <button id="btnLogin" class="w-full py-4 bg-gray-900 dark:bg-white text-white dark:text-black rounded-2xl font-bold hover:scale-[1.02] transition-transform flex items-center justify-center gap-3">
                <i data-lucide="lock" class="w-4 h-4"></i> Masuk Secure Area
            </button>
        </div>
    </div>

    <aside class="hidden md:flex w-72 flex-col bg-white dark:bg-dark-900 border-r border-gray-100 dark:border-gray-800 z-20">
        <div class="p-8">
            <div class="flex items-center gap-3 text-brand-600">
                <i data-lucide="hexagon" class="w-8 h-8 fill-current"></i>
                <span class="text-xl font-bold text-gray-900 dark:text-white tracking-tight">Haken.</span>
            </div>
        </div>

        <nav class="flex-1 px-4 space-y-2">
            <button onclick="switchTab('dashboard')" id="nav-dashboard" class="nav-item active w-full flex items-center gap-3 px-4 py-3.5 text-sm font-semibold text-gray-500 dark:text-gray-400 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-all">
                <i data-lucide="layout-grid" class="w-5 h-5"></i> Dashboard
            </button>
            <button onclick="switchTab('orders')" id="nav-orders" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-semibold text-gray-500 dark:text-gray-400 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-all">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i> Pesanan
                <span id="badgeOrderSide" class="ml-auto bg-brand-600 text-white text-[10px] px-2 py-0.5 rounded-full hidden">0</span>
            </button>
            <button onclick="switchTab('inventory')" id="nav-inventory" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-semibold text-gray-500 dark:text-gray-400 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-all">
                <i data-lucide="package" class="w-5 h-5"></i> Inventaris
            </button>
            <button onclick="window.location.href='database.html'" class="nav-item w-full flex items-center gap-3 px-4 py-3.5 text-sm font-semibold text-gray-500 dark:text-gray-400 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-all">
                <i data-lucide="database" class="w-5 h-5"></i> Master Data
            </button>
        </nav>

        <div class="p-6 border-t border-gray-100 dark:border-gray-800">
            <div class="flex items-center gap-3 mb-4 px-2">
                <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-brand-500 to-purple-600"></div>
                <div class="overflow-hidden">
                    <p class="text-xs font-bold text-gray-900 dark:text-white">Administrator</p>
                    <p id="adminEmail" class="text-[10px] text-gray-400 truncate">...</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="toggleTheme()" class="flex-1 p-2 rounded-lg border border-gray-200 dark:border-gray-700 flex justify-center hover:bg-gray-50 dark:hover:bg-dark-800">
                    <i data-lucide="moon" class="w-4 h-4 dark:hidden"></i>
                    <i data-lucide="sun" class="w-4 h-4 hidden dark:block text-yellow-400"></i>
                </button>
                <button onclick="handleLogout()" class="flex-1 p-2 rounded-lg border border-red-100 dark:border-red-900/30 text-red-500 flex justify-center hover:bg-red-50 dark:hover:bg-red-900/20">
                    <i data-lucide="log-out" class="w-4 h-4"></i>
                </button>
            </div>
        </div>
    </aside>

    <main class="flex-1 overflow-y-auto relative scroll-smooth" id="mainArea">
        <div class="md:hidden sticky top-0 z-30 glass-panel px-6 py-4 flex justify-between items-center border-b dark:border-gray-800">
            <span class="font-bold text-lg">Haken.</span>
            <button onclick="handleLogout()" class="text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
        </div>

        <div class="p-6 md:p-10 max-w-7xl mx-auto space-y-8 min-h-screen">

            <div id="tab-dashboard" class="space-y-8 animate-in fade-in zoom-in duration-300">
                <div class="flex justify-between items-end">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-900 dark:text-white">Overview</h2>
                        <p class="text-gray-500 text-sm">Performansi toko real-time.</p>
                    </div>
                    <span class="flex items-center gap-2 text-xs font-bold text-green-500 bg-green-50 dark:bg-green-900/20 px-3 py-1 rounded-full animate-pulse">
                        <span class="w-2 h-2 rounded-full bg-green-500"></span> Live Update
                    </span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <div class="p-6 rounded-3xl bg-white dark:bg-dark-900 border border-gray-100 dark:border-gray-800 shadow-sm">
                        <div class="flex justify-between mb-4">
                            <div class="p-2 bg-brand-50 dark:bg-brand-900/20 rounded-lg text-brand-600"><i data-lucide="wallet" class="w-5 h-5"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Pendapatan Hari Ini</p>
                        <h3 class="text-2xl font-bold mt-1" id="statToday">Rp 0</h3>
                    </div>
                    <div class="p-6 rounded-3xl bg-white dark:bg-dark-900 border border-gray-100 dark:border-gray-800 shadow-sm">
                        <div class="flex justify-between mb-4">
                            <div class="p-2 bg-blue-50 dark:bg-blue-900/20 rounded-lg text-blue-600"><i data-lucide="shopping-cart" class="w-5 h-5"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Order Aktif</p>
                        <h3 class="text-2xl font-bold mt-1" id="statActiveOrders">0</h3>
                    </div>
                    <div class="p-6 rounded-3xl bg-white dark:bg-dark-900 border border-gray-100 dark:border-gray-800 shadow-sm">
                        <div class="flex justify-between mb-4">
                            <div class="p-2 bg-purple-50 dark:bg-purple-900/20 rounded-lg text-purple-600"><i data-lucide="users" class="w-5 h-5"></i></div>
                        </div>
                        <p class="text-xs text-gray-400 uppercase font-bold tracking-wider">Total Member</p>
                        <h3 class="text-2xl font-bold mt-1" id="statUsers">0</h3>
                    </div>
                    <div class="p-6 rounded-3xl bg-gray-900 dark:bg-white text-white dark:text-black shadow-lg">
                        <div class="flex justify-between mb-4">
                            <i data-lucide="trending-up" class="w-6 h-6 opacity-80"></i>
                        </div>
                        <p class="text-xs opacity-60 uppercase font-bold tracking-wider">Total Revenue</p>
                        <h3 class="text-2xl font-bold mt-1" id="statRevenue">Rp 0</h3>
                    </div>
                </div>

                <div class="p-6 md:p-8 rounded-[2rem] bg-white dark:bg-dark-900 border border-gray-100 dark:border-gray-800 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-bold text-lg">Tren Penjualan</h3>
                        <div class="flex gap-2 bg-gray-100 dark:bg-dark-800 p-1 rounded-xl">
                            <button onclick="updateChart('day')" id="btn-day" class="px-4 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-dark-900 shadow-sm transition-all">24J</button>
                            <button onclick="updateChart('week')" id="btn-week" class="px-4 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-900 transition-all">7H</button>
                        </div>
                    </div>
                    <div class="h-64 w-full">
                        <canvas id="mainChart"></canvas>
                    </div>
                </div>
            </div>

            <div id="tab-orders" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Pesanan Masuk</h2>
                    <div class="flex gap-2">
                        <span class="px-3 py-1 bg-white dark:bg-dark-800 border dark:border-gray-800 rounded-lg text-xs font-bold flex items-center gap-2">
                            <span class="w-2 h-2 rounded-full bg-orange-500 animate-pulse"></span>
                            Live
                        </span>
                    </div>
                </div>

                <div id="ordersContainer" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                    </div>
            </div>

            <div id="tab-inventory" class="hidden space-y-6">
                <div class="flex justify-between items-center">
                    <h2 class="text-2xl font-bold">Inventaris</h2>
                    <button onclick="openProductModal()" class="px-6 py-2.5 bg-brand-600 hover:bg-brand-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-brand-600/20 transition-all flex items-center gap-2">
                        <i data-lucide="plus" class="w-4 h-4"></i> Tambah
                    </button>
                </div>

                <div class="bg-white dark:bg-dark-900 rounded-3xl border border-gray-100 dark:border-gray-800 overflow-hidden shadow-sm">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 dark:bg-dark-800 text-gray-500 uppercase text-xs font-bold">
                            <tr>
                                <th class="p-6">Produk</th>
                                <th class="p-6">Harga</th>
                                <th class="p-6">Stok</th>
                                <th class="p-6 text-right">Aksi</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryList" class="divide-y divide-gray-100 dark:divide-gray-800">
                            </tbody>
                    </table>
                </div>
            </div>

        </div>
    </main>

    <nav class="md:hidden fixed bottom-0 w-full bg-white/90 dark:bg-dark-900/90 backdrop-blur-md border-t dark:border-gray-800 flex justify-around p-4 z-40 pb-[env(safe-area-inset-bottom)]">
        <button onclick="switchTab('dashboard')" class="text-brand-600"><i data-lucide="layout-grid" class="w-6 h-6"></i></button>
        <button onclick="switchTab('orders')" class="relative text-gray-400">
            <i data-lucide="shopping-bag" class="w-6 h-6"></i>
            <span id="badgeOrderMob" class="absolute -top-1 -right-1 w-3 h-3 bg-red-500 rounded-full hidden"></span>
        </button>
        <button onclick="switchTab('inventory')" class="text-gray-400"><i data-lucide="package" class="w-6 h-6"></i></button>
    </nav>

    <div id="statusModal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 opacity-0 transition-opacity duration-300">
        <div class="bg-white dark:bg-dark-900 w-full max-w-sm rounded-[2rem] p-8 shadow-2xl border dark:border-gray-800 transform scale-95 transition-transform duration-300">
            <h3 class="font-bold text-xl mb-6 text-center">Update Status Pesanan</h3>
            <input type="hidden" id="statusOrderId">
            
            <div class="space-y-3 relative">
                <div class="absolute left-4 top-4 bottom-4 w-0.5 bg-gray-100 dark:bg-gray-800 -z-10"></div>

                <button onclick="setStatus('Pesanan Sedang Ditinjau')" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors text-left group">
                    <div class="w-8 h-8 rounded-full bg-orange-100 text-orange-600 flex items-center justify-center font-bold text-xs shadow-sm group-hover:scale-110 transition-transform">1</div>
                    <div><div class="font-bold text-sm">Ditinjau</div><div class="text-[10px] text-gray-400">Cek pembayaran</div></div>
                </button>
                <button onclick="setStatus('Pesanan Sedang Dikemas')" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors text-left group">
                    <div class="w-8 h-8 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs shadow-sm group-hover:scale-110 transition-transform">2</div>
                    <div><div class="font-bold text-sm">Dikemas</div><div class="text-[10px] text-gray-400">Siapkan barang</div></div>
                </button>
                <button onclick="setStatus('Pesanan Dikirim')" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors text-left group">
                    <div class="w-8 h-8 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center font-bold text-xs shadow-sm group-hover:scale-110 transition-transform">3</div>
                    <div><div class="font-bold text-sm">Dikirim</div><div class="text-[10px] text-gray-400">Serahkan ke kurir</div></div>
                </button>
                <button onclick="setStatus('Selesai')" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors text-left group">
                    <div class="w-8 h-8 rounded-full bg-green-100 text-green-600 flex items-center justify-center font-bold text-xs shadow-sm group-hover:scale-110 transition-transform">4</div>
                    <div><div class="font-bold text-sm">Selesai</div><div class="text-[10px] text-gray-400">Transaksi beres</div></div>
                </button>
                <div class="h-px bg-gray-100 dark:bg-gray-800 my-2"></div>
                <button onclick="setStatus('Dibatalkan')" class="w-full flex items-center gap-4 p-3 rounded-xl hover:bg-red-50 dark:hover:bg-red-900/10 transition-colors text-left text-red-500">
                    <div class="w-8 h-8 rounded-full bg-red-100 text-red-500 flex items-center justify-center font-bold text-xs shadow-sm"><i data-lucide="x" class="w-4 h-4"></i></div>
                    <div class="font-bold text-sm">Batalkan Pesanan</div>
                </button>
            </div>
            
            <button onclick="closeModal('statusModal')" class="mt-6 w-full py-3 bg-gray-100 dark:bg-dark-800 rounded-xl text-xs font-bold text-gray-500 hover:bg-gray-200 transition-colors">Tutup</button>
        </div>
    </div>

    <div id="productModal" class="hidden fixed inset-0 z-[60] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white dark:bg-dark-900 w-full max-w-md rounded-[2rem] p-8 shadow-2xl border dark:border-gray-800 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-xl">Editor Produk</h3>
                <button onclick="closeModal('productModal')" class="p-2 bg-gray-100 dark:bg-dark-800 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="editId">
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Nama Produk</label>
                    <input type="text" id="pName" required class="input-modern mt-1">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Harga (Rp)</label>
                        <input type="number" id="pPrice" required class="input-modern mt-1">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-400 uppercase ml-1">Stok</label>
                        <input type="number" id="pStock" required class="input-modern mt-1">
                    </div>
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Kategori</label>
                    <input type="text" id="pCategory" required class="input-modern mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">URL Gambar</label>
                    <input type="text" id="pImage" required class="input-modern mt-1">
                </div>
                <div>
                    <label class="text-xs font-bold text-gray-400 uppercase ml-1">Deskripsi</label>
                    <textarea id="pDesc" rows="3" class="input-modern mt-1"></textarea>
                </div>
                <button type="submit" class="w-full py-4 bg-brand-600 hover:bg-brand-500 text-white rounded-xl font-bold shadow-lg shadow-brand-500/30 transition-all">Simpan Perubahan</button>
            </form>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, update, remove, get, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyApD7dueaFuPv9hHGajcwo17LADEVriqRw",
            authDomain: "entry-6a64d.firebaseapp.com",
            databaseURL: "https://entry-6a64d-default-rtdb.firebaseio.com",
            projectId: "entry-6a64d",
            storageBucket: "entry-6a64d.firebasestorage.app",
            messagingSenderId: "939693440034",
            appId: "1:939693440034:web:ecd3d0366acf207add1e7b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();
        provider.setCustomParameters({ prompt: 'select_account' });

        let allOrders = [];
        let chartInstance = null;

        // AUTH HANDLER
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // Cek Admin Rights
                const snap = await get(ref(db, 'admins/' + user.uid));
                if (snap.exists() && snap.val() === true) {
                    document.getElementById('loginGate').classList.add('hidden');
                    document.getElementById('adminEmail').textContent = user.email;
                    initRealtimeListeners();
                } else {
                    alert("Akses Ditolak: Anda bukan Admin.");
                    window.location.href = 'index.html';
                }
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
        window.handleLogout = () => signOut(auth).then(() => window.location.reload());

        // --- REALTIME DATA CORE ---
        function initRealtimeListeners() {
            lucide.createIcons();

            // 1. LISTEN ORDERS (AUTO UPDATE CHART & LIST)
            onValue(ref(db, 'orders'), (snapshot) => {
                const data = snapshot.val();
                allOrders = [];
                let revenue = 0, todayRev = 0, activeCount = 0;
                const todayStr = new Date().toDateString();

                const listContainer = document.getElementById('ordersContainer');
                listContainer.innerHTML = ''; // Reset UI

                if (data) {
                    const sorted = Object.entries(data).sort((a,b) => b.val().timestamp - a.val().timestamp);
                    
                    // Update Badge
                    const activeOrders = sorted.filter(([_, o]) => !o.status.includes('Selesai') && !o.status.includes('Batal'));
                    document.getElementById('badgeOrderSide').textContent = activeOrders.length;
                    document.getElementById('badgeOrderSide').classList.remove('hidden');
                    document.getElementById('badgeOrderMob').classList.remove('hidden');

                    sorted.forEach(([id, o]) => {
                        // SINKRONISASI DATA PINTAR
                        // Baca struktur baru (customer object) atau lama (flat)
                        const custName = o.customer?.name || o.customerName || 'Guest';
                        const total = o.pricing?.grandTotal || o.total || 0;
                        const date = new Date(o.timestamp);
                        
                        // Items Display
                        let itemText = o.items ? o.items.map(i => `${i.name} (x${i.qty})`).join(', ') : (o.productName || 'Unknown Item');

                        // Data untuk Statistik & Chart
                        if (!o.status.includes('Batalkan')) {
                            allOrders.push({ date: date, total: total });
                            revenue += total;
                            if (date.toDateString() === todayStr) todayRev += total;
                            if (!o.status.includes('Selesai')) activeCount++;
                        }

                        // Render Card Pesanan
                        let statusBadge = '';
                        if(o.status.includes('Ditinjau')) statusBadge = '<span class="text-orange-600 bg-orange-100 px-2 py-1 rounded text-[10px] font-bold">DITINJAU</span>';
                        else if(o.status.includes('Dikemas')) statusBadge = '<span class="text-blue-600 bg-blue-100 px-2 py-1 rounded text-[10px] font-bold">DIKEMAS</span>';
                        else if(o.status.includes('Dikirim')) statusBadge = '<span class="text-indigo-600 bg-indigo-100 px-2 py-1 rounded text-[10px] font-bold">DIKIRIM</span>';
                        else if(o.status.includes('Selesai')) statusBadge = '<span class="text-green-600 bg-green-100 px-2 py-1 rounded text-[10px] font-bold">SELESAI</span>';
                        else statusBadge = '<span class="text-red-600 bg-red-100 px-2 py-1 rounded text-[10px] font-bold">BATAL</span>';

                        const cardHTML = `
                            <div class="bg-white dark:bg-dark-800 p-5 rounded-2xl border border-gray-100 dark:border-gray-800 shadow-sm hover:shadow-md transition-all">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold text-gray-900 dark:text-white">${custName}</h4>
                                        <p class="text-[10px] text-gray-400 font-mono">ID: ${id.slice(-6)} â€¢ ${date.toLocaleDateString()}</p>
                                    </div>
                                    ${statusBadge}
                                </div>
                                <div class="p-3 bg-gray-50 dark:bg-black/30 rounded-xl mb-3">
                                    <p class="text-xs text-gray-600 dark:text-gray-400 line-clamp-2">${itemText}</p>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="font-bold text-brand-600">Rp ${total.toLocaleString()}</span>
                                    <button onclick="openStatusModal('${id}')" class="text-xs font-bold bg-gray-900 text-white px-3 py-1.5 rounded-lg hover:bg-gray-700 transition-colors">Update Status</button>
                                </div>
                            </div>
                        `;
                        listContainer.innerHTML += cardHTML;
                    });
                }

                // Update Angka Dashboard
                document.getElementById('statToday').textContent = `Rp ${todayRev.toLocaleString()}`;
                document.getElementById('statRevenue').textContent = `Rp ${revenue.toLocaleString()}`;
                document.getElementById('statActiveOrders').textContent = activeCount;

                // Force Update Chart Tanpa Klik
                updateChart('day'); 
            });

            // 2. LISTEN PRODUCTS
            onValue(ref(db, 'products'), (snapshot) => {
                const tbody = document.getElementById('inventoryList');
                tbody.innerHTML = '';
                const data = snapshot.val();
                if(data) {
                    // Sync ke LocalStorage agar index.html tidak perlu fetch ulang
                    localStorage.setItem('haken_public_collection', JSON.stringify(data));
                    
                    Object.entries(data).forEach(([id, p]) => {
                        tbody.innerHTML += `
                            <tr class="border-b border-gray-50 dark:border-gray-800 hover:bg-gray-50 dark:hover:bg-dark-800 transition-colors">
                                <td class="p-6 font-medium text-gray-900 dark:text-white flex items-center gap-3">
                                    <img src="${p.image}" class="w-10 h-10 rounded-lg object-cover bg-gray-200">
                                    ${p.name}
                                </td>
                                <td class="p-6 text-gray-500">Rp ${parseInt(p.price).toLocaleString()}</td>
                                <td class="p-6"><span class="font-bold ${p.stock < 5 ? 'text-red-500' : 'text-green-500'}">${p.stock} pcs</span></td>
                                <td class="p-6 text-right space-x-2">
                                    <button onclick="editProduct('${id}')" class="text-blue-500 hover:bg-blue-50 p-2 rounded-lg"><i data-lucide="edit-2" class="w-4 h-4"></i></button>
                                    <button onclick="deleteProduct('${id}')" class="text-red-500 hover:bg-red-50 p-2 rounded-lg"><i data-lucide="trash" class="w-4 h-4"></i></button>
                                </td>
                            </tr>
                        `;
                    });
                    lucide.createIcons();
                }
            });

            // 3. LISTEN USERS COUNT
            onValue(ref(db, 'users'), (snap) => {
                document.getElementById('statUsers').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
            });
        }

        // --- CHART LOGIC (AUTO RENDER) ---
        window.updateChart = (period) => {
            const btnDay = document.getElementById('btn-day');
            const btnWeek = document.getElementById('btn-week');
            
            // Simple Toggle Style
            [btnDay, btnWeek].forEach(b => {
                b.className = "px-4 py-1.5 text-xs font-bold rounded-lg text-gray-500 hover:text-gray-900 transition-all";
            });
            document.getElementById(`btn-${period}`).className = "px-4 py-1.5 text-xs font-bold rounded-lg bg-white dark:bg-dark-900 shadow-sm transition-all text-brand-600";

            const ctx = document.getElementById('mainChart').getContext('2d');
            const now = new Date();
            let labels = [], data = [];

            if (period === 'day') {
                labels = Array.from({length: 12}, (_, i) => `${i*2}:00`); // 00:00, 02:00...
                data = new Array(12).fill(0);
                allOrders.forEach(o => {
                    if (o.date.toDateString() === now.toDateString()) {
                        const slot = Math.floor(o.date.getHours() / 2);
                        data[slot] += o.total;
                    }
                });
            } else if (period === 'week') {
                labels = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
                data = new Array(7).fill(0);
                const startOfWeek = new Date(now);
                startOfWeek.setDate(now.getDate() - 6);
                allOrders.forEach(o => {
                    if (o.date >= startOfWeek) data[o.date.getDay()] += o.total;
                });
            }

            if (chartInstance) chartInstance.destroy();
            
            // Gradient Fill
            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
            gradient.addColorStop(0, 'rgba(234, 88, 12, 0.2)');
            gradient.addColorStop(1, 'rgba(234, 88, 12, 0)');

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendapatan',
                        data: data,
                        borderColor: '#ea580c',
                        backgroundColor: gradient,
                        borderWidth: 2,
                        tension: 0.4, // Curved lines
                        fill: true,
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, border: { display: false } },
                        x: { grid: { display: false }, border: { display: false } }
                    }
                }
            });
        };

        // --- MODAL & TABS ---
        window.switchTab = (tab) => {
            ['dashboard', 'orders', 'inventory'].forEach(t => {
                document.getElementById('tab-'+t).classList.add('hidden');
                document.getElementById('nav-'+t)?.classList.remove('bg-brand-50', 'text-brand-600', 'dark:bg-brand-900/20', 'dark:text-brand-500', 'active');
            });
            document.getElementById('tab-'+tab).classList.remove('hidden');
            const nav = document.getElementById('nav-'+tab);
            if(nav) nav.classList.add('bg-brand-50', 'text-brand-600', 'dark:bg-brand-900/20', 'dark:text-brand-500', 'active');
        };

        // Product Logic
        window.openProductModal = () => { document.getElementById('productForm').reset(); document.getElementById('editId').value=''; openModal('productModal'); }
        document.getElementById('productForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value || Date.now().toString();
            update(ref(db, 'products/' + id), {
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                stock: document.getElementById('pStock').value,
                category: document.getElementById('pCategory').value,
                image: document.getElementById('pImage').value,
                desc: document.getElementById('pDesc').value
            }).then(() => closeModal('productModal'));
        });
        
        window.deleteProduct = (id) => confirm('Hapus?') && remove(ref(db, 'products/'+id));
        window.editProduct = (id) => {
            get(ref(db, 'products/'+id)).then(snap => {
                const p = snap.val();
                document.getElementById('editId').value = id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pPrice').value = p.price;
                document.getElementById('pStock').value = p.stock;
                document.getElementById('pCategory').value = p.category;
                document.getElementById('pImage').value = p.image;
                document.getElementById('pDesc').value = p.desc;
                openModal('productModal');
            });
        };

        // Status Logic
        window.openStatusModal = (id) => {
            document.getElementById('statusOrderId').value = id;
            openModal('statusModal');
        };
        window.setStatus = (status) => {
            const id = document.getElementById('statusOrderId').value;
            update(ref(db, 'orders/' + id), { status: status, lastStatusUpdate: Date.now() })
            .then(() => closeModal('statusModal'));
        };

        // Helper Modals
        window.openModal = (id) => {
            const el = document.getElementById(id);
            el.classList.remove('hidden');
            setTimeout(() => { el.classList.remove('opacity-0'); el.firstElementChild.classList.remove('scale-95'); }, 10);
        }
        window.closeModal = (id) => {
            const el = document.getElementById(id);
            el.classList.add('opacity-0');
            el.firstElementChild.classList.add('scale-95');
            setTimeout(() => el.classList.add('hidden'), 300);
        }

        // Theme Toggle
        window.toggleTheme = () => {
            document.documentElement.classList.toggle('dark');
            localStorage.setItem('theme', document.documentElement.classList.contains('dark') ? 'dark' : 'light');
        };
        if(localStorage.getItem('theme') === 'dark') document.documentElement.classList.add('dark');

    </script>
</body>
</html>
