<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Haken Admin Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap'); 
        body { font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .desk-nav { @apply w-full flex items-center gap-3 px-4 py-3 text-stone-500 hover:bg-stone-50 rounded-xl text-sm font-bold transition-all; }
        .desk-nav.active { @apply bg-stone-900 text-white shadow-lg shadow-stone-200; }
        
        .mob-nav { @apply text-stone-400 transition-colors; }
        .mob-nav.active { @apply text-orange-600; }
        .mob-nav.active i { @apply fill-orange-100; }

        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        .animate-slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }
    </style>
</head>
<body class="bg-stone-50 text-stone-800 h-screen overflow-hidden">

    <div id="loginGate" class="fixed inset-0 z-[100] bg-stone-900 flex items-center justify-center p-4">
        <div class="bg-white p-8 rounded-3xl w-full max-w-sm text-center shadow-2xl">
            <div class="w-16 h-16 bg-stone-100 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="shield-check" class="w-8 h-8 text-stone-900"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2">Haken Admin</h2>
            <p class="text-stone-500 text-sm mb-8">Secure Database Access.</p>
            <button id="btnLogin" class="w-full py-3 bg-stone-900 text-white rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5">
                Login Administrator
            </button>
            <p id="loginStatus" class="text-stone-400 text-xs mt-4 hidden">Memverifikasi hak akses...</p>
        </div>
    </div>

    <div id="dashboardUI" class="flex h-full hidden flex-col md:flex-row">
        
        <aside class="hidden md:flex w-64 bg-white border-r border-stone-200 flex-col z-20">
            <div class="p-6 border-b border-stone-100">
                <div class="flex items-center gap-2 mb-1">
                    <img src="https://image2url.com/r2/default/images/1769841539779-0d5772d3-1c34-4b3b-9d7a-984c2a64b403.png" class="w-6 h-6 object-contain">
                    <span class="text-lg font-bold tracking-tight text-stone-900">Haken Admin.</span>
                </div>
                <p id="adminEmailDisplay" class="text-[10px] text-stone-400 truncate">Loading...</p>
                <span class="inline-block px-2 py-0.5 bg-green-100 text-green-700 text-[9px] font-bold rounded mt-1">SECURE CONNECTION</span>
            </div>
            <nav class="flex-1 p-4 space-y-1">
                <button onclick="window.switchTab('insight')" id="desk-insight" class="desk-nav active"><i data-lucide="bar-chart-3" class="w-4 h-4"></i> Overview</button>
                <button onclick="window.switchTab('orders')" id="desk-orders" class="desk-nav"><i data-lucide="shopping-bag" class="w-4 h-4"></i> Pesanan</button>
                <button onclick="window.switchTab('products')" id="desk-products" class="desk-nav"><i data-lucide="package" class="w-4 h-4"></i> Produk</button>
                <button onclick="window.switchTab('discounts')" id="desk-discounts" class="desk-nav"><i data-lucide="ticket-percent" class="w-4 h-4"></i> Diskon</button>
                <button onclick="window.switchTab('settings')" id="desk-settings" class="desk-nav"><i data-lucide="settings" class="w-4 h-4"></i> Setting</button>
            </nav>
            <div class="p-4 border-t border-stone-100">
                <button id="btnLogout" class="w-full flex items-center gap-2 px-4 py-2 text-xs font-bold text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                    <i data-lucide="log-out" class="w-3 h-3"></i> Keluar
                </button>
            </div>
        </aside>

        <main class="flex-1 overflow-y-auto bg-stone-50/50 pb-24 md:pb-0 relative">
            <div class="md:hidden sticky top-0 z-30 bg-white/80 backdrop-blur-md border-b border-stone-200 px-6 py-4 flex justify-between items-center">
                <span class="font-bold text-lg">Haken Dashboard</span>
                <button onclick="window.logout()" class="text-red-500"><i data-lucide="log-out" class="w-5 h-5"></i></button>
            </div>

            <div class="p-6 md:p-10 max-w-7xl mx-auto">
                
                <div id="tab-insight" class="animate-fade-in space-y-4">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Ringkasan Bisnis</h1>
                    <div class="grid grid-cols-1 gap-4 md:grid-cols-3">
                        <div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                            <div>
                                <span class="text-xs font-bold text-stone-400 block mb-1">TOTAL USER</span>
                                <h2 id="statUsers" class="text-2xl font-bold text-stone-900">0</h2>
                            </div>
                            <div class="p-3 bg-orange-50 rounded-xl text-orange-600"><i data-lucide="users" class="w-6 h-6"></i></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                            <div>
                                <span class="text-xs font-bold text-stone-400 block mb-1">TOTAL OMSET</span>
                                <h2 id="statRevenue" class="text-2xl font-bold text-stone-900">Rp 0</h2>
                            </div>
                            <div class="p-3 bg-green-50 rounded-xl text-green-600"><i data-lucide="wallet" class="w-6 h-6"></i></div>
                        </div>
                        <div class="bg-white p-5 rounded-2xl border border-stone-100 shadow-sm flex items-center justify-between">
                            <div>
                                <span class="text-xs font-bold text-stone-400 block mb-1">BULAN INI</span>
                                <h2 id="statMonth" class="text-2xl font-bold text-stone-900">Rp 0</h2>
                            </div>
                            <div class="p-3 bg-blue-50 rounded-xl text-blue-600"><i data-lucide="calendar" class="w-6 h-6"></i></div>
                        </div>
                    </div>
                </div>

                <div id="tab-orders" class="hidden animate-fade-in pb-20">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Pesanan Masuk</h1>
                    <div id="orderList" class="space-y-4"></div>
                </div>

                <div id="tab-products" class="hidden animate-fade-in pb-20">
                    <div class="flex justify-between items-center mb-4">
                        <h1 class="text-xl md:text-2xl font-bold">Stok Produk</h1>
                        <button onclick="window.openProductModal()" class="w-10 h-10 bg-stone-900 text-white rounded-full flex items-center justify-center shadow-lg active:scale-90 transition-transform">
                            <i data-lucide="plus" class="w-5 h-5"></i>
                        </button>
                    </div>
                    <div class="bg-white rounded-2xl border border-stone-200 overflow-hidden">
                        <div class="overflow-x-auto">
                            <table class="w-full text-left text-sm whitespace-nowrap">
                                <thead class="bg-stone-50 text-stone-500 font-bold uppercase text-xs">
                                    <tr><th class="p-4">Produk</th><th class="p-4">Stok</th><th class="p-4 text-right">Aksi</th></tr>
                                </thead>
                                <tbody id="productTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div id="tab-discounts" class="hidden animate-fade-in pb-20">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Atur Promo</h1>
                    <div class="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm space-y-4">
                        <div>
                            <label class="text-xs font-bold text-stone-500 uppercase">Pilih Produk</label>
                            <select id="discProductSelect" class="w-full mt-1 p-3 bg-stone-50 border border-stone-200 rounded-xl text-sm outline-none focus:border-orange-500"></select>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs font-bold text-stone-500 uppercase">Harga Promo</label>
                                <input type="number" id="discPrice" class="w-full mt-1 p-3 border border-stone-200 rounded-xl text-sm">
                            </div>
                            <div>
                                <label class="text-xs font-bold text-stone-500 uppercase">Kuota</label>
                                <input type="number" id="discStock" class="w-full mt-1 p-3 border border-stone-200 rounded-xl text-sm">
                            </div>
                        </div>
                        <button onclick="window.applyDiscount()" class="w-full py-3 bg-orange-600 text-white rounded-xl font-bold shadow-lg shadow-orange-200 active:scale-95 transition-transform">Pasang Diskon</button>
                    
                        <div class="pt-4 border-t border-stone-100">
                            <h3 class="font-bold text-sm mb-2">Sedang Promo:</h3>
                            <ul id="activeDiscounts" class="space-y-2"></ul>
                        </div>
                    </div>
                </div>

                <div id="tab-settings" class="hidden animate-fade-in">
                    <h1 class="text-xl md:text-2xl font-bold mb-4">Pengaturan</h1>
                    <div class="bg-white p-5 rounded-2xl border border-stone-200 shadow-sm">
                        <label class="text-xs font-bold text-stone-500 uppercase">Link QRIS (Gambar)</label>
                        <input type="text" id="settingQris" class="w-full mt-2 mb-4 p-3 border border-stone-200 rounded-xl text-sm" placeholder="https://...">
                        <button onclick="window.saveSettings()" class="w-full py-3 bg-stone-900 text-white rounded-xl font-bold active:scale-95 transition-transform">Simpan</button>
                        <div class="mt-4 p-3 bg-blue-50 text-blue-800 text-xs rounded-xl flex gap-2">
                            <i data-lucide="info" class="w-4 h-4 shrink-0"></i>
                            <p>Keamanan aktif: Hanya akun yang terdaftar di database 'admins' yang bisa menyimpan perubahan.</p>
                        </div>
                    </div>
                </div>

            </div>
        </main>

        <nav class="md:hidden fixed bottom-0 left-0 w-full bg-white border-t border-stone-200 flex justify-around items-center px-2 py-3 pb-safe z-40 shadow-[0_-5px_10px_rgba(0,0,0,0.02)]">
            <button onclick="window.switchTab('insight')" id="mob-insight" class="mob-nav active flex flex-col items-center gap-1 w-full">
                <i data-lucide="bar-chart-2" class="w-5 h-5"></i>
                <span class="text-[10px] font-medium">Home</span>
            </button>
            <button onclick="window.switchTab('orders')" id="mob-orders" class="mob-nav flex flex-col items-center gap-1 w-full relative">
                <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                <span class="text-[10px] font-medium">Order</span>
            </button>
            <button onclick="window.switchTab('products')" id="mob-products" class="mob-nav flex flex-col items-center gap-1 w-full">
                <i data-lucide="package" class="w-5 h-5"></i>
                <span class="text-[10px] font-medium">Produk</span>
            </button>
            <button onclick="window.switchTab('discounts')" id="mob-discounts" class="mob-nav flex flex-col items-center gap-1 w-full">
                <i data-lucide="percent" class="w-5 h-5"></i>
                <span class="text-[10px] font-medium">Promo</span>
            </button>
            <button onclick="window.switchTab('settings')" id="mob-settings" class="mob-nav flex flex-col items-center gap-1 w-full">
                <i data-lucide="settings" class="w-5 h-5"></i>
                <span class="text-[10px] font-medium">Akun</span>
            </button>
        </nav>

    </div>

    <div id="productModal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4">
        <div class="bg-white w-full md:max-w-md rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up md:animate-fade-in max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-lg font-bold">Edit / Tambah</h2>
                <button onclick="window.closeProductModal()" class="p-2 bg-stone-100 rounded-full"><i data-lucide="x" class="w-4 h-4"></i></button>
            </div>
            <form id="productForm" class="space-y-4">
                <input type="hidden" id="editId">
                <input type="text" id="pName" placeholder="Nama Produk" required class="w-full p-3 border rounded-xl text-sm bg-stone-50">
                <div class="grid grid-cols-2 gap-3">
                    <input type="number" id="pPrice" placeholder="Harga" required class="w-full p-3 border rounded-xl text-sm bg-stone-50">
                    <input type="number" id="pStock" placeholder="Stok" required class="w-full p-3 border rounded-xl text-sm bg-stone-50">
                </div>
                <select id="pCategory" class="w-full p-3 border rounded-xl text-sm bg-stone-50">
                    <option value="Small Items">Small Items</option>
                    <option value="Medium">Medium</option>
                    <option value="Statement">Statement</option>
                </select>
                <input type="text" id="pImage" placeholder="URL Gambar" required class="w-full p-3 border rounded-xl text-sm bg-stone-50">
                <textarea id="pDesc" placeholder="Deskripsi" rows="3" class="w-full p-3 border rounded-xl text-sm bg-stone-50"></textarea>
                <button type="submit" class="w-full py-3 bg-stone-900 text-white rounded-xl font-bold text-sm">Simpan</button>
            </form>
        </div>
    </div>

    <div id="statusModal" class="hidden fixed inset-0 z-[60] bg-black/50 backdrop-blur-sm flex items-end md:items-center justify-center sm:p-4">
        <div class="bg-white w-full md:max-w-sm rounded-t-3xl md:rounded-3xl p-6 shadow-2xl animate-slide-up md:animate-fade-in">
            <h2 class="text-lg font-bold mb-4">Pilih Status Order</h2>
            <input type="hidden" id="statusOrderId">
            <div class="space-y-2 overflow-y-auto max-h-[60vh]">
                <button onclick="window.setStatus('Pesanan Sedang Ditinjau')" class="w-full text-left p-3 rounded-xl bg-orange-50 text-orange-700 font-bold text-sm">1. Ditinjau</button>
                <button onclick="window.setStatus('Pesanan Sedang Dikemas')" class="w-full text-left p-3 rounded-xl bg-stone-50 text-stone-700 font-bold text-sm">2. Dikemas</button>
                <button onclick="window.setStatus('Pesanan Sedang Diantarkan ke Jasa Logistik')" class="w-full text-left p-3 rounded-xl bg-stone-50 text-stone-700 font-bold text-sm">3. OTW Logistik</button>
                <button onclick="window.setStatus('Pesanan Sedang Diantarkan oleh Jasa Logistik')" class="w-full text-left p-3 rounded-xl bg-blue-50 text-blue-700 font-bold text-sm">4. Dikirim Kurir</button>
                <button onclick="window.setStatus('Pesanan Diterima')" class="w-full text-left p-3 rounded-xl bg-green-50 text-green-700 font-bold text-sm">5. Selesai (Diterima)</button>
                <div class="h-px bg-stone-100 my-2"></div>
                <button onclick="window.setStatus('Pesanan Dibatalkan')" class="w-full text-left p-3 rounded-xl bg-red-50 text-red-700 font-bold text-sm">X. Batalkan</button>
            </div>
            <button onclick="document.getElementById('statusModal').classList.add('hidden')" class="mt-4 w-full py-3 bg-stone-100 font-bold rounded-xl text-sm">Tutup</button>
        </div>
    </div>

    <script type="module">
        import { db, auth, provider, ref, set, onValue, remove, update, signInWithPopup, signOut, onAuthStateChanged, get } from './firebase-config.js';

        // --- PROTOKOL KEAMANAN BARU ---
        // Array email dihapus. Diganti dengan pengecekan langsung ke Database.
        
        onAuthStateChanged(auth, async (user) => {
            const loginStatus = document.getElementById('loginStatus');
            const loginGate = document.getElementById('loginGate');
            const dashboardUI = document.getElementById('dashboardUI');

            if (user) {
                // User login, tapi cek dulu apakah dia Admin di Database
                if(loginStatus) {
                    loginStatus.classList.remove('hidden');
                    loginStatus.textContent = "Memeriksa izin database...";
                }

                try {
                    // Cek ke tabel 'admins'
                    const snapshot = await get(ref(db, 'admins/' + user.uid));
                    
                    if (snapshot.exists() && snapshot.val() === true) {
                        // SUKSES: User valid
                        loginGate.style.display = 'none';
                        dashboardUI.classList.remove('hidden');
                        document.getElementById('adminEmailDisplay').textContent = user.email;
                        lucide.createIcons();
                        initAdmin(); // Load data
                    } else {
                        // GAGAL: User login Google, tapi tidak ada di tabel 'admins'
                        alert("AKSES DITOLAK: Akun Google ini tidak terdaftar sebagai Admin Haken Studio.");
                        await signOut(auth);
                        window.location.reload();
                    }
                } catch (error) {
                    console.error("Auth Check Error:", error);
                    alert("Terjadi kesalahan koneksi saat memverifikasi admin.");
                }

            } else {
                // Belum login
                if(loginStatus) loginStatus.classList.add('hidden');
                // Jika user logout manual, user kembali ke halaman profile otomatis diatur oleh logic lain atau tetap di sini
            }
        });

        document.getElementById('btnLogin').addEventListener('click', () => signInWithPopup(auth, provider));
        document.getElementById('btnLogout').addEventListener('click', () => signOut(auth).then(()=>window.location.reload()));
        window.logout = () => signOut(auth).then(()=>window.location.reload());

        function initAdmin() {
            loadInsights();
            loadProducts();
            loadOrders();
            loadSettings();
        }

        // 1. INSIGHT
        function loadInsights() {
            onValue(ref(db, 'users'), (snap) => {
                document.getElementById('statUsers').textContent = snap.exists() ? Object.keys(snap.val()).length : 0;
            });
            onValue(ref(db, 'orders'), (snap) => {
                let total = 0; let monthTotal = 0;
                const currentMonth = new Date().getMonth();
                if (snap.exists()) {
                    Object.values(snap.val()).forEach(o => {
                        // Hitung omset hanya jika status 'valid'
                        if (['Pesanan Diterima', 'Selesai', 'Lunas'].some(s => o.status.includes(s))) {
                            total += o.total;
                            if (new Date(o.timestamp).getMonth() === currentMonth) monthTotal += o.total;
                        }
                    });
                }
                document.getElementById('statRevenue').textContent = 'Rp ' + total.toLocaleString('id-ID');
                document.getElementById('statMonth').textContent = 'Rp ' + monthTotal.toLocaleString('id-ID');
            });
        }

        // 2. ORDERS
        function loadOrders() {
            onValue(ref(db, 'orders'), (snapshot) => {
                const list = document.getElementById('orderList');
                list.innerHTML = '';
                const data = snapshot.val();
                
                if(data) {
                    const orders = Object.entries(data).sort((a,b) => b.val().timestamp - a.val().timestamp);
                    orders.forEach(([id, o]) => {
                        // Auto-complete logic (opsional, bisa diaktifkan jika butuh)
                        if (o.status === 'Pesanan Diterima' && (Date.now() - o.lastStatusUpdate > 259200000)) { 
                            update(ref(db, 'orders/'+id), { status: 'Selesai' });
                        }

                        let colorClass = 'bg-stone-100 text-stone-600 border-stone-200';
                        if(o.status.includes('Ditinjau')) colorClass = 'bg-orange-50 text-orange-700 border-orange-100';
                        if(o.status.includes('Diterima') || o.status === 'Selesai') colorClass = 'bg-green-50 text-green-700 border-green-100';
                        if(o.status.includes('Dibatalkan')) colorClass = 'bg-red-50 text-red-700 border-red-100';

                        list.innerHTML += `
                            <div class="bg-white p-4 rounded-2xl border border-stone-100 shadow-sm">
                                <div class="flex justify-between items-start mb-3">
                                    <div>
                                        <h4 class="font-bold text-stone-900">${o.customerName}</h4>
                                        <div class="text-[10px] text-stone-400 font-mono mt-0.5">${new Date(o.timestamp).toLocaleDateString()} â€¢ ID: ${id.slice(-4)}</div>
                                    </div>
                                    <span class="px-2 py-1 rounded-lg text-[10px] font-bold uppercase border ${colorClass}">${o.status}</span>
                                </div>
                                <div class="flex gap-3 mb-3">
                                    <div class="w-12 h-12 bg-stone-100 rounded-lg flex-shrink-0 flex items-center justify-center">
                                        <i data-lucide="package" class="w-5 h-5 text-stone-400"></i>
                                    </div>
                                    <div>
                                        <div class="font-bold text-sm">${o.productName}</div>
                                        <div class="text-xs text-stone-500">Qty: ${o.qty} x</div>
                                        <div class="text-xs font-bold text-orange-600 mt-0.5">Total: Rp ${parseInt(o.total).toLocaleString()}</div>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <a href="https://wa.me/${o.customerPhone}" target="_blank" class="flex-1 py-2.5 bg-stone-50 text-stone-600 rounded-xl text-xs font-bold text-center">Chat WA</a>
                                    <button onclick="window.openStatusModal('${id}')" class="flex-1 py-2.5 bg-stone-900 text-white rounded-xl text-xs font-bold">Update Status</button>
                                </div>
                            </div>`;
                    });
                    lucide.createIcons();
                } else {
                    list.innerHTML = `<div class="text-center py-10 text-stone-400 text-sm">Belum ada pesanan.</div>`;
                }
            });
        }

        // Logic Modal Status
        window.openStatusModal = (id) => {
            document.getElementById('statusOrderId').value = id;
            document.getElementById('statusModal').classList.remove('hidden');
        };
        window.setStatus = (status) => {
            const id = document.getElementById('statusOrderId').value;
            // Catch error permission denied
            update(ref(db, 'orders/' + id), { status: status, lastStatusUpdate: Date.now() })
            .then(() => document.getElementById('statusModal').classList.add('hidden'))
            .catch((err) => alert("Gagal update: Anda tidak memiliki izin Admin Database."));
        };

        // 3. PRODUCTS
        function loadProducts() {
            const tbody = document.getElementById('productTableBody');
            const select = document.getElementById('discProductSelect');
            const discList = document.getElementById('activeDiscounts');
            
            onValue(ref(db, 'products'), (snap) => {
                tbody.innerHTML = ''; select.innerHTML = '<option value="">Pilih...</option>'; discList.innerHTML = '';
                const data = snap.val();
                if(data) {
                    Object.entries(data).forEach(([id, p]) => {
                        // Product List
                        tbody.innerHTML += `
                            <tr class="border-b border-stone-50">
                                <td class="p-4">
                                    <div class="font-bold text-stone-800">${p.name}</div>
                                    <div class="text-xs text-stone-400">Rp ${parseInt(p.price).toLocaleString()}</div>
                                    ${p.discountStock > 0 ? '<span class="text-[10px] text-red-500 font-bold">Promo Aktif</span>' : ''}
                                </td>
                                <td class="p-4 font-bold ${p.stock<5?'text-red-500':''}">${p.stock}</td>
                                <td class="p-4 text-right">
                                    <button onclick="window.editProduct('${id}')" class="p-2 bg-stone-100 rounded-lg text-blue-600 mr-1"><i data-lucide="edit-2" class="w-3 h-3"></i></button>
                                    <button onclick="window.deleteProduct('${id}')" class="p-2 bg-red-50 rounded-lg text-red-500"><i data-lucide="trash" class="w-3 h-3"></i></button>
                                </td>
                            </tr>`;
                        
                        select.innerHTML += `<option value="${id}">${p.name}</option>`;
                        
                        if(p.discountStock > 0) {
                            discList.innerHTML += `
                                <li class="flex justify-between items-center bg-stone-50 p-3 rounded-xl border border-stone-100">
                                    <div>
                                        <div class="text-xs font-bold text-stone-900">${p.name}</div>
                                        <div class="text-[10px] text-stone-500">Sisa Kuota: ${p.discountStock}</div>
                                    </div>
                                    <button onclick="window.stopDiscount('${id}')" class="text-[10px] font-bold text-red-500 bg-red-50 px-2 py-1 rounded">Stop</button>
                                </li>`;
                        }
                    });
                    lucide.createIcons();
                }
            });
        }

        // CRUD & UTILS (Dengan Error Handling)
        window.applyDiscount = () => {
            const id = document.getElementById('discProductSelect').value;
            const price = document.getElementById('discPrice').value;
            const stock = document.getElementById('discStock').value;
            if(!id || !price || !stock) return alert("Lengkapi data!");
            
            update(ref(db, 'products/' + id), { discountPrice: parseInt(price), discountStock: parseInt(stock) })
                .then(()=>alert("Promo Aktif!"))
                .catch(err => alert("Gagal: Akses Ditolak Database."));
        };
        
        window.stopDiscount = (id) => update(ref(db, 'products/' + id), { discountStock: 0 }).catch(err => alert("Gagal stop promo."));
        
        window.saveSettings = () => {
            set(ref(db, 'settings'), { qrisUrl: document.getElementById('settingQris').value })
                .then(()=>alert("Disimpan!"))
                .catch(err => alert("Gagal menyimpan setting. Pastikan Anda Admin."));
        };
        
        function loadSettings() { onValue(ref(db, 'settings'), (snap) => { if(snap.val()?.qrisUrl) document.getElementById('settingQris').value = snap.val().qrisUrl; }); }

        window.switchTab = (tab) => {
            ['insight', 'orders', 'products', 'discounts', 'settings'].forEach(t => {
                document.getElementById('tab-'+t).classList.add('hidden');
                document.getElementById('desk-'+t)?.classList.remove('active');
                document.getElementById('mob-'+t)?.classList.remove('active');
            });
            document.getElementById('tab-'+tab).classList.remove('hidden');
            document.getElementById('desk-'+tab)?.classList.add('active');
            document.getElementById('mob-'+tab)?.classList.add('active');
        };

        const form = document.getElementById('productForm');
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = document.getElementById('editId').value || Date.now().toString();
            update(ref(db, 'products/' + id), {
                name: document.getElementById('pName').value,
                price: document.getElementById('pPrice').value,
                stock: document.getElementById('pStock').value,
                category: document.getElementById('pCategory').value,
                image: document.getElementById('pImage').value,
                desc: document.getElementById('pDesc').value
            })
            .then(() => window.closeProductModal())
            .catch(err => alert("Gagal menyimpan produk: Izin ditolak."));
        });

        window.deleteProduct = (id) => { 
            if(confirm('Hapus?')) remove(ref(db, 'products/' + id)).catch(err => alert("Gagal hapus.")); 
        };
        
        window.editProduct = (id) => {
            get(ref(db, 'products/' + id)).then((snapshot) => {
                const p = snapshot.val();
                document.getElementById('editId').value = id;
                document.getElementById('pName').value = p.name;
                document.getElementById('pPrice').value = p.price;
                document.getElementById('pStock').value = p.stock;
                document.getElementById('pCategory').value = p.category;
                document.getElementById('pImage').value = p.image;
                document.getElementById('pDesc').value = p.desc;
                window.openProductModal();
            });
        };
        window.openProductModal = () => { document.getElementById('productForm').reset(); document.getElementById('editId').value = ''; document.getElementById('productModal').classList.remove('hidden'); };
        window.closeProductModal = () => document.getElementById('productModal').classList.add('hidden');
    </script>
</body>
</html>
