<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - Haken Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } }
                }
            }
        }
    </script>
</head>
<body class="bg-[#fcfaf8] font-sans text-stone-800 antialiased min-h-screen">

    <header class="bg-white border-b border-stone-200 sticky top-0 z-40">
        <div class="container mx-auto px-6 h-16 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 text-stone-500 hover:text-stone-900 transition-colors text-sm font-medium">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
            </a>
            <div class="flex items-center gap-2">
                <i data-lucide="lock" class="w-4 h-4 text-green-600"></i>
                <span class="font-serif font-bold text-stone-900 tracking-tight">Checkout Secure</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 lg:py-12">
        
        <div id="emptyState" class="hidden text-center py-20 animate-fade-in-up">
            <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-stone-100">
                <i data-lucide="shopping-bag" class="w-10 h-10 text-stone-300"></i>
            </div>
            <h2 class="text-2xl font-serif font-bold text-stone-900 mb-2">Keranjang Kosong</h2>
            <a href="index.html" class="inline-flex px-8 py-3 bg-stone-900 text-white rounded-xl font-bold hover:bg-orange-600 transition-all shadow-lg">Lihat Katalog</a>
        </div>

        <div id="checkoutContent" class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 items-start">
            
            <div class="lg:col-span-7 space-y-8">
                
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-stone-100">
                    <div class="flex items-center gap-3 mb-6 pb-6 border-b border-stone-100">
                        <div class="w-10 h-10 rounded-full bg-stone-900 text-white flex items-center justify-center font-bold font-serif">1</div>
                        <div>
                            <h3 class="font-bold text-lg text-stone-900">Data Pengiriman</h3>
                            <p class="text-xs text-stone-400">Pastikan data Anda valid.</p>
                        </div>
                    </div>
                    
                    <form id="checkoutForm" class="space-y-5">
                        <input type="text" id="custName" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-900 outline-none transition-all font-medium" placeholder="Nama Lengkap">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <input type="tel" id="custPhone" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-900 outline-none transition-all font-medium" placeholder="No. WhatsApp (08...)">
                            <input type="text" id="custCity" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-900 outline-none transition-all font-medium" placeholder="Kota / Kecamatan">
                        </div>
                        <textarea id="custAddress" rows="3" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:border-stone-900 outline-none transition-all font-medium" placeholder="Alamat Lengkap..."></textarea>
                    </form>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-sm border border-stone-100">
                    <div class="flex items-center justify-between mb-6 pb-6 border-b border-stone-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-stone-100 text-stone-900 flex items-center justify-center font-bold font-serif">2</div>
                            <div>
                                <h3 class="font-bold text-lg text-stone-900">Item Pesanan</h3>
                            </div>
                        </div>
                    </div>
                    <div id="orderItemsContainer" class="space-y-4"></div>
                </div>
            </div>

            <div class="lg:col-span-5 relative">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-stone-100 sticky top-24">
                    
                    <div class="text-center mb-6">
                        <div class="inline-block p-2 rounded-2xl border-2 border-dashed border-stone-200 bg-stone-50 mb-3">
                            <img id="qrisImage" src="https://via.placeholder.com/200?text=Memuat+QRIS..." class="w-40 h-40 object-contain mix-blend-multiply mx-auto">
                        </div>
                        <p class="text-xs font-bold text-stone-400 uppercase tracking-widest">Scan QRIS Haken Studio</p>
                    </div>

                    <div class="space-y-3 mb-6 bg-stone-50 p-4 rounded-xl border border-stone-100">
                        <div class="flex justify-between text-sm text-stone-600">
                            <span>Subtotal</span>
                            <span id="summarySubtotal" class="font-bold">IDR 0</span>
                        </div>
                        <div class="flex justify-between text-sm text-orange-600">
                            <span>Kode Unik</span>
                            <span id="summaryCode" class="font-bold">+ 0</span>
                        </div>
                        <div class="h-px bg-stone-200 my-2"></div>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-stone-900">Total Transfer</span>
                            <span id="summaryTotal" class="text-xl font-serif font-bold text-stone-900">IDR 0</span>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="block text-xs font-bold text-stone-500 uppercase mb-2">Upload Bukti Transfer (Wajib)</label>
                        <div class="relative">
                            <input type="file" id="paymentProof" accept="image/*" class="w-full text-sm text-stone-500 file:mr-4 file:py-2.5 file:px-4 file:rounded-xl file:border-0 file:text-xs file:font-bold file:bg-stone-900 file:text-white hover:file:bg-stone-700 transition-all cursor-pointer bg-stone-50 border border-stone-200 rounded-xl">
                        </div>
                        <p class="text-[10px] text-stone-400 mt-2">*Otomatis dikompres agar hemat kuota.</p>
                    </div>

                    <button onclick="processCheckout()" id="btnProcess" class="w-full py-4 bg-stone-900 text-white rounded-xl font-bold text-lg hover:bg-stone-800 transition-all shadow-lg flex items-center justify-center gap-2">
                        <i data-lucide="send" class="w-5 h-5"></i>
                        Kirim ke Database
                    </button>
                    
                </div>
            </div>
        </div>
    </main>

    <div id="successModal" class="hidden fixed inset-0 z-50 bg-stone-900/90 backdrop-blur-sm flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full text-center shadow-2xl animate-fade-in-up">
            <div class="w-16 h-16 bg-green-100 text-green-600 rounded-full flex items-center justify-center mx-auto mb-6">
                <i data-lucide="check" class="w-8 h-8"></i>
            </div>
            <h2 class="text-2xl font-bold text-stone-900 mb-2">Pesanan Masuk!</h2>
            <p class="text-stone-500 text-sm mb-6">Data Anda sudah tersimpan aman di database kami.</p>
            
            <a id="waLinkBtn" href="#" class="block w-full py-4 bg-green-600 text-white rounded-xl font-bold hover:bg-green-700 transition-all shadow-lg flex items-center justify-center gap-2 mb-3">
                <i data-lucide="message-circle" class="w-5 h-5"></i>
                Konfirmasi ke WhatsApp
            </a>
            <button onclick="window.location.href='index.html'" class="text-xs text-stone-400 font-bold hover:text-stone-900">Kembali ke Beranda</button>
        </div>
    </div>

    <div id="loadingOverlay" class="hidden fixed inset-0 z-[60] bg-white/80 backdrop-blur-md flex flex-col items-center justify-center">
        <div class="animate-spin w-12 h-12 border-4 border-stone-200 border-t-stone-900 rounded-full mb-4"></div>
        <h3 class="font-bold text-stone-900">Mengirim Data...</h3>
        <p class="text-xs text-stone-500 mt-1">Mengompres gambar & sinkronisasi database.</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_URL = "https://entry-6a64d-default-rtdb.firebaseio.com";
        const ADMIN_WA = "6285959180745"; 

        let cart = [];
        let uniqueCode = 0;
        let finalTotal = 0;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadCart();
            fetchSettings();
        });

        // 1. LOAD KERANJANG
        function loadCart() {
            const raw = localStorage.getItem('haken_cart');
            if (!raw || JSON.parse(raw).length === 0) {
                document.getElementById('checkoutContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            cart = JSON.parse(raw);
            renderItems();
            calculateTotal();
        }

        // 2. RENDER ITEMS
        function renderItems() {
            const container = document.getElementById('orderItemsContainer');
            container.innerHTML = cart.map((item, index) => `
                <div class="flex gap-4 items-center group p-3 rounded-xl hover:bg-stone-50 transition-colors border border-stone-100">
                    <img src="${item.image}" class="w-16 h-16 rounded-xl object-cover bg-stone-200">
                    <div class="flex-1">
                        <h4 class="font-bold text-stone-900 text-sm">${item.name}</h4>
                        <div class="flex justify-between items-center mt-1">
                            <span class="text-xs text-stone-500">Qty: ${item.qty}</span>
                            <span class="font-bold text-stone-900 text-sm">IDR ${(item.price * item.qty).toLocaleString()}</span>
                        </div>
                    </div>
                    <button onclick="removeItem(${index})" class="text-stone-300 hover:text-red-500"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                </div>`).join('');
            lucide.createIcons();
        }

        // 3. HITUNG TOTAL (Kode Unik = 100 + Qty)
        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            const totalQty = cart.reduce((sum, item) => sum + parseInt(item.qty), 0);
            uniqueCode = 100 + totalQty; 
            finalTotal = subtotal + uniqueCode;

            document.getElementById('summarySubtotal').textContent = `IDR ${subtotal.toLocaleString()}`;
            document.getElementById('summaryCode').textContent = `+ ${uniqueCode}`;
            document.getElementById('summaryTotal').textContent = `IDR ${finalTotal.toLocaleString()}`;
        }

        // 4. FETCH QRIS
        async function fetchSettings() {
            try {
                const res = await fetch(`${DB_URL}/settings.json`);
                const data = await res.json();
                if(data?.qrisUrl) document.getElementById('qrisImage').src = data.qrisUrl;
            } catch (e) {}
        }

        window.removeItem = (index) => {
            if(confirm("Hapus?")) {
                cart.splice(index, 1);
                localStorage.setItem('haken_cart', JSON.stringify(cart));
                loadCart();
            }
        };

        // --- FUNGSI KOMPRESI GAMBAR (PENTING AGAR ADMIN TIDAK LEMOT) ---
        const compressImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        // Ubah ukuran jadi kecil (Thumbnail only)
                        const scaleSize = 300; 
                        const scale = scaleSize / img.width;
                        canvas.width = scaleSize;
                        canvas.height = img.height * scale;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        
                        // Kompres jadi JPEG kualitas rendah (0.5)
                        resolve(canvas.toDataURL('image/jpeg', 0.5)); 
                    };
                };
                reader.onerror = error => reject(error);
            });
        };

        // --- CORE PROCESS ---
        window.processCheckout = async () => {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const city = document.getElementById('custCity').value.trim();
            const address = document.getElementById('custAddress').value.trim();
            const fileInput = document.getElementById('paymentProof');

            // 1. Validasi Input
            if(!name || !phone || !city || !address) {
                alert("Mohon lengkapi semua data pengiriman.");
                return;
            }

            // 2. Validasi Bukti Transfer (WAJIB)
            if (fileInput.files.length === 0) {
                alert("Wajib upload bukti transfer sebelum mengirim pesanan.");
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                // 3. Kompres Gambar Dulu
                const base64Image = await compressImage(fileInput.files[0]);

                // 4. Cek Stok Server
                for (const item of cart) {
                    const res = await fetch(`${DB_URL}/products/${item.productId}.json`);
                    const serverProd = await res.json();
                    const available = item.isPromo ? serverProd.discountStock : serverProd.stock;
                    
                    if (available < item.qty) {
                        alert(`Stok "${item.name}" habis/kurang. Sisa: ${available}`);
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        return;
                    }
                }

                // 5. Susun Data Order
                const orderData = {
                    orderId: `ORD-${Date.now().toString().slice(-6)}`,
                    customer: { name, phone, city, address },
                    items: cart,
                    pricing: {
                        subtotal: finalTotal - uniqueCode,
                        uniqueCode: uniqueCode,
                        grandTotal: finalTotal
                    },
                    paymentProof: base64Image, // Gambar kecil masuk DB
                    status: 'Pesanan Baru (Menunggu Verifikasi)',
                    timestamp: Date.now(),
                    lastStatusUpdate: Date.now()
                };

                // 6. Kirim ke Firebase (POST)
                await fetch(`${DB_URL}/orders.json`, {
                    method: 'POST',
                    body: JSON.stringify(orderData),
                    headers: { 'Content-Type': 'application/json' }
                });

                // 7. Potong Stok (PATCH)
                const updates = cart.map(async (item) => {
                    const res = await fetch(`${DB_URL}/products/${item.productId}.json`);
                    const prod = await res.json();
                    const field = item.isPromo ? 'discountStock' : 'stock';
                    return fetch(`${DB_URL}/products/${item.productId}.json`, {
                        method: 'PATCH',
                        body: JSON.stringify({ [field]: prod[field] - item.qty })
                    });
                });
                await Promise.all(updates);

                // 8. Sukses -> Tampilkan Modal Konfirmasi WA
                localStorage.removeItem('haken_cart');
                document.getElementById('loadingOverlay').classList.add('hidden');
                
                // Siapkan Link WA
                const waMsg = `*KONFIRMASI PESANAN - HAKEN*\nID: ${orderData.orderId}\n\nHalo Admin, saya sudah transfer dan upload bukti di website.\n\nNama: ${name}\nTotal: IDR ${finalTotal.toLocaleString()}\n\nMohon segera diproses.`;
                document.getElementById('waLinkBtn').href = `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(waMsg)}`;
                
                document.getElementById('successModal').classList.remove('hidden');

            } catch (error) {
                console.error(error);
                alert("Terjadi kesalahan. Coba lagi.");
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
