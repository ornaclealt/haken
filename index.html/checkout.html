<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout Aman - Haken Studio</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:ital,wght@0,300;0,700;1,300&family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'], serif: ['Merriweather', 'serif'] },
                    colors: { stone: { 50: '#fafaf9', 100: '#f5f5f4', 800: '#292524', 900: '#1c1917' } }
                }
            }
        }
    </script>
</head>
<body class="bg-[#fcfaf8] font-sans text-stone-800 antialiased min-h-screen">

    <header class="bg-white border-b border-stone-200 sticky top-0 z-40">
        <div class="container mx-auto px-6 h-16 flex items-center justify-between">
            <a href="index.html" class="flex items-center gap-2 text-stone-500 hover:text-stone-900 transition-colors text-sm font-medium">
                <i data-lucide="arrow-left" class="w-4 h-4"></i> Kembali
            </a>
            <div class="flex items-center gap-2">
                <i data-lucide="lock" class="w-4 h-4 text-green-600"></i>
                <span class="font-serif font-bold text-stone-900 tracking-tight">Checkout Secure</span>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-6 py-8 lg:py-12">
        
        <div id="emptyState" class="hidden text-center py-20 animate-fade-in-up">
            <div class="w-24 h-24 bg-white rounded-full flex items-center justify-center mx-auto mb-6 shadow-sm border border-stone-100">
                <i data-lucide="shopping-bag" class="w-10 h-10 text-stone-300"></i>
            </div>
            <h2 class="text-2xl font-serif font-bold text-stone-900 mb-2">Keranjang Anda Kosong</h2>
            <p class="text-stone-500 mb-8">Mari isi dengan karya rajutan spesial kami.</p>
            <a href="index.html" class="inline-flex px-8 py-3 bg-stone-900 text-white rounded-xl font-bold hover:bg-orange-600 transition-all shadow-lg hover:shadow-orange-600/20">
                Lihat Katalog
            </a>
        </div>

        <div id="checkoutContent" class="grid grid-cols-1 lg:grid-cols-12 gap-8 lg:gap-12 items-start">
            
            <div class="lg:col-span-7 space-y-8">
                
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-[0_2px_20px_rgba(0,0,0,0.02)] border border-stone-100">
                    <div class="flex items-center gap-3 mb-6 pb-6 border-b border-stone-100">
                        <div class="w-10 h-10 rounded-full bg-stone-900 text-white flex items-center justify-center font-bold font-serif">1</div>
                        <div>
                            <h3 class="font-bold text-lg text-stone-900">Alamat Pengiriman</h3>
                            <p class="text-xs text-stone-400">Pastikan data Anda benar</p>
                        </div>
                    </div>
                    
                    <form id="checkoutForm" class="space-y-5">
                        <div>
                            <label class="block text-xs font-bold uppercase text-stone-500 mb-2 tracking-wider">Nama Lengkap</label>
                            <input type="text" id="custName" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:bg-white focus:border-stone-900 focus:ring-0 outline-none transition-all font-medium" placeholder="Cth: Latiefa Cahyaning">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                            <div>
                                <label class="block text-xs font-bold uppercase text-stone-500 mb-2 tracking-wider">Nomor WhatsApp</label>
                                <input type="tel" id="custPhone" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:bg-white focus:border-stone-900 focus:ring-0 outline-none transition-all font-medium" placeholder="0812...">
                            </div>
                            <div>
                                <label class="block text-xs font-bold uppercase text-stone-500 mb-2 tracking-wider">Kota / Kecamatan</label>
                                <input type="text" id="custCity" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:bg-white focus:border-stone-900 focus:ring-0 outline-none transition-all font-medium" placeholder="Cth: Sleman, Jogja">
                            </div>
                        </div>
                        <div>
                            <label class="block text-xs font-bold uppercase text-stone-500 mb-2 tracking-wider">Alamat Lengkap</label>
                            <textarea id="custAddress" rows="3" class="w-full p-4 bg-stone-50 border border-stone-200 rounded-xl focus:bg-white focus:border-stone-900 focus:ring-0 outline-none transition-all font-medium" placeholder="Nama Jalan, No. Rumah, RT/RW..."></textarea>
                        </div>
                    </form>
                </div>

                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-[0_2px_20px_rgba(0,0,0,0.02)] border border-stone-100">
                    <div class="flex items-center justify-between mb-6 pb-6 border-b border-stone-100">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-stone-100 text-stone-900 flex items-center justify-center font-bold font-serif">2</div>
                            <div>
                                <h3 class="font-bold text-lg text-stone-900">Daftar Pesanan</h3>
                                <p class="text-xs text-stone-400">Cek kembali belanjaan Anda</p>
                            </div>
                        </div>
                    </div>
                    <div id="orderItemsContainer" class="space-y-4">
                        </div>
                </div>
            </div>

            <div class="lg:col-span-5 relative">
                <div class="bg-white p-6 md:p-8 rounded-3xl shadow-xl shadow-stone-200/60 border border-stone-100 sticky top-24">
                    
                    <div class="text-center mb-8">
                        <div class="inline-block p-1 rounded-2xl border-2 border-dashed border-stone-200 bg-stone-50 mb-3">
                            <div class="bg-white rounded-xl overflow-hidden p-2">
                                <img id="qrisImage" src="https://via.placeholder.com/200?text=Loading..." class="w-48 h-48 object-contain mix-blend-multiply mx-auto">
                            </div>
                        </div>
                        <p class="text-xs font-bold text-stone-400 uppercase tracking-widest">Scan QRIS Pembayaran</p>
                        <p class="text-[10px] text-stone-400 mt-1">Haken Studio Official</p>
                    </div>

                    <div class="space-y-3 mb-8">
                        <div class="flex justify-between text-sm text-stone-600">
                            <span>Total Harga Barang</span>
                            <span id="summarySubtotal" class="font-bold text-stone-900">IDR 0</span>
                        </div>
                        <div class="flex justify-between text-sm text-orange-600 bg-orange-50 p-2 rounded-lg">
                            <span class="flex items-center gap-1.5">
                                <i data-lucide="hash" class="w-3 h-3"></i> Kode Unik (Jumlah Qty)
                            </span>
                            <span id="summaryCode" class="font-bold">+ 0</span>
                        </div>
                        
                        <div class="h-px bg-stone-100 my-2"></div>
                        
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-bold text-stone-500">Total Transfer</span>
                            <span id="summaryTotal" class="text-2xl font-serif font-bold text-stone-900">IDR 0</span>
                        </div>
                    </div>

                    <button onclick="processCheckout()" id="btnProcess" class="group w-full py-4 bg-stone-900 text-white rounded-xl font-bold text-lg hover:bg-green-600 transition-all shadow-lg hover:shadow-green-600/30 flex items-center justify-center gap-3 relative overflow-hidden">
                        <div class="absolute inset-0 w-full h-full bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        <span class="relative flex items-center gap-2">
                            <i data-lucide="check-circle" class="w-5 h-5"></i>
                            Saya Sudah Transfer
                        </span>
                    </button>
                    
                    <p class="text-center text-[10px] text-stone-400 mt-4 leading-relaxed">
                        Dengan mengklik tombol di atas, pesanan akan otomatis masuk ke sistem kami dan Anda akan diarahkan ke WhatsApp untuk konfirmasi.
                    </p>
                </div>
            </div>
        </div>
    </main>

    <div id="loadingOverlay" class="hidden fixed inset-0 z-50 bg-white/90 backdrop-blur-sm flex flex-col items-center justify-center transition-all">
        <div class="relative">
            <div class="animate-spin w-16 h-16 border-4 border-stone-100 border-t-stone-900 rounded-full mb-6"></div>
            <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 -mt-3">
                <i data-lucide="loader" class="w-6 h-6 text-stone-900 animate-pulse"></i>
            </div>
        </div>
        <h3 class="font-serif font-bold text-xl text-stone-900 mb-2">Memproses Pesanan...</h3>
        <p class="text-sm text-stone-500">Mohon tunggu sebentar, jangan tutup halaman ini.</p>
    </div>

    <script>
        // --- CONFIGURATION ---
        const DB_URL = "https://entry-6a64d-default-rtdb.firebaseio.com";
        const ADMIN_WA = "6285959180745"; 

        // State Global
        let cart = [];
        let uniqueCode = 0;
        let totalQty = 0;
        let finalTotal = 0;

        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();
            loadCart();
            fetchSettings(); // Ambil QRIS
        });

        // 1. LOAD KERANJANG
        function loadCart() {
            const raw = localStorage.getItem('haken_cart');
            if (!raw || JSON.parse(raw).length === 0) {
                document.getElementById('checkoutContent').classList.add('hidden');
                document.getElementById('emptyState').classList.remove('hidden');
                return;
            }
            
            cart = JSON.parse(raw);
            renderItems();
            calculateTotal();
        }

        // 2. RENDER ITEM (Tampilan List Bagus)
        function renderItems() {
            const container = document.getElementById('orderItemsContainer');
            container.innerHTML = cart.map((item, index) => `
                <div class="flex gap-4 items-center group p-3 rounded-xl hover:bg-stone-50 transition-colors">
                    <div class="relative w-20 h-20 rounded-xl overflow-hidden border border-stone-200">
                        <img src="${item.image}" class="w-full h-full object-cover">
                        ${item.isPromo ? '<div class="absolute top-0 right-0 bg-red-500 w-3 h-3 rounded-bl-lg"></div>' : ''}
                    </div>
                    <div class="flex-1">
                        <div class="flex justify-between items-start">
                            <h4 class="font-bold text-stone-900 text-sm md:text-base">${item.name}</h4>
                            <button onclick="removeItem(${index})" class="text-stone-300 hover:text-red-500 transition-colors">
                                <i data-lucide="trash-2" class="w-4 h-4"></i>
                            </button>
                        </div>
                        <p class="text-xs text-stone-500 mb-2">Harga Satuan: IDR ${parseInt(item.price).toLocaleString()}</p>
                        <div class="flex items-center justify-between">
                            <span class="px-2 py-1 bg-white border border-stone-200 rounded text-xs font-bold text-stone-600">x${item.qty}</span>
                            <span class="font-bold text-stone-900">IDR ${(item.price * item.qty).toLocaleString()}</span>
                        </div>
                    </div>
                </div>
            `).join('');
            lucide.createIcons();
        }

        // 3. HITUNG TOTAL & KODE UNIK (REQ: Berdasarkan Jumlah Barang)
        function calculateTotal() {
            const subtotal = cart.reduce((sum, item) => sum + (item.price * item.qty), 0);
            
            // Hitung Total Qty Barang
            totalQty = cart.reduce((sum, item) => sum + parseInt(item.qty), 0);
            
            // LOGIKA KODE UNIK: 100 + Total Qty
            // Contoh: Beli 5 barang -> Kode 105
            // Contoh: Beli 12 barang -> Kode 112
            uniqueCode = 100 + totalQty;

            finalTotal = subtotal + uniqueCode;

            // Render ke UI
            document.getElementById('summarySubtotal').textContent = `IDR ${subtotal.toLocaleString()}`;
            document.getElementById('summaryCode').textContent = `+ ${uniqueCode}`;
            document.getElementById('summaryTotal').textContent = `IDR ${finalTotal.toLocaleString()}`;
        }

        // 4. FETCH QRIS
        async function fetchSettings() {
            try {
                const res = await fetch(`${DB_URL}/settings.json`);
                const data = await res.json();
                if(data && data.qrisUrl) {
                    document.getElementById('qrisImage').src = data.qrisUrl;
                }
            } catch (e) { console.log("Gagal load QRIS"); }
        }

        // 5. HAPUS ITEM
        window.removeItem = (index) => {
            if(confirm("Hapus produk ini dari pesanan?")) {
                cart.splice(index, 1);
                localStorage.setItem('haken_cart', JSON.stringify(cart));
                loadCart();
            }
        };

        // 6. PROSES CHECKOUT (DATABASE + WA)
        window.processCheckout = async () => {
            const name = document.getElementById('custName').value.trim();
            const phone = document.getElementById('custPhone').value.trim();
            const city = document.getElementById('custCity').value.trim();
            const address = document.getElementById('custAddress').value.trim();

            if(!name || !phone || !city || !address) {
                alert("Mohon lengkapi semua data pengiriman (Nomor 1).");
                window.scrollTo({ top: 0, behavior: 'smooth' });
                return;
            }

            document.getElementById('loadingOverlay').classList.remove('hidden');

            try {
                // A. VALIDASI STOK SERVER
                for (const item of cart) {
                    const res = await fetch(`${DB_URL}/products/${item.productId}.json`);
                    const serverProd = await res.json();
                    const available = item.isPromo ? serverProd.discountStock : serverProd.stock;
                    
                    if (available < item.qty) {
                        alert(`Ups! Stok untuk "${item.name}" tidak cukup. Sisa: ${available}`);
                        document.getElementById('loadingOverlay').classList.add('hidden');
                        return;
                    }
                }

                // B. SIMPAN ORDER KE FIREBASE
                const orderId = `ORD-${Date.now().toString().slice(-6)}`;
                const orderData = {
                    orderId: orderId,
                    customer: { name, phone, city, address },
                    items: cart,
                    pricing: {
                        subtotal: finalTotal - uniqueCode,
                        uniqueCode: uniqueCode, // Ini yang sesuai Qty tadi
                        grandTotal: finalTotal
                    },
                    status: 'Menunggu Konfirmasi Pembayaran',
                    timestamp: Date.now(),
                    lastStatusUpdate: Date.now()
                };

                await fetch(`${DB_URL}/orders.json`, {
                    method: 'POST',
                    body: JSON.stringify(orderData),
                    headers: { 'Content-Type': 'application/json' }
                });

                // C. POTONG STOK OTOMATIS
                const updates = cart.map(async (item) => {
                    const res = await fetch(`${DB_URL}/products/${item.productId}.json`);
                    const prod = await res.json();
                    const field = item.isPromo ? 'discountStock' : 'stock';
                    const newVal = prod[field] - item.qty;

                    return fetch(`${DB_URL}/products/${item.productId}.json`, {
                        method: 'PATCH',
                        body: JSON.stringify({ [field]: newVal })
                    });
                });
                await Promise.all(updates);

                // D. CLEAR CART & REDIRECT WA
                localStorage.removeItem('haken_cart');
                const waLink = generateWAMessage(orderData);
                window.location.href = waLink;

            } catch (error) {
                console.error(error);
                alert("Gagal memproses pesanan. Periksa koneksi internet Anda.");
                document.getElementById('loadingOverlay').classList.add('hidden');
            }
        };

        function generateWAMessage(order) {
            let itemsList = order.items.map(i => `- ${i.name} (${i.qty} pcs)`).join('\n');
            
            const msg = `*KONFIRMASI PEMBAYARAN - HAKEN*
Order ID: ${order.orderId}

*Detail Pesanan:*
${itemsList}

*Total Transfer:*
IDR ${order.pricing.grandTotal.toLocaleString()}
(Sudah termasuk kode unik ${order.pricing.uniqueCode})

*Pengirim:*
${order.customer.name}
${order.customer.city}

_Bukti transfer terlampir (Screenshot)._`;

            return `https://wa.me/${ADMIN_WA}?text=${encodeURIComponent(msg)}`;
        }
    </script>
</body>
</html>
